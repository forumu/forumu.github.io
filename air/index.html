<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YOUSHE - Depot Air Minum Isi Ulang</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #134e4a;
            --primary-light: #165a56;
            --primary-dark: #0f423e;
            --secondary-color: #06b6d4;
            --accent-color: #14b8a6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
            --white: #ffffff;
            --card-shadow: 0 1px 2px rgba(0,0,0,0.1);
            --card-hover-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f1f5f9;
            color: var(--dark-color);
            overflow-x: hidden;
            padding-bottom: 60px;
        }
        
        /* Processing Overlay - Baru */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .processing-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .processing-content {
            text-align: center;
            color: white;
        }
        
        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }
        
        .processing-text {
            font-size: 18px;
            font-weight: 500;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Header */
        .app-header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 12px 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(19, 78, 74, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-logo {
            width: 32px;
            height: 32px;
            background-color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            overflow: hidden;
        }
        .header-logo i {
            color: var(--primary-color);
            font-size: 20px;
        }
        .header-title {
            flex: 1;
        }
        .header-title h1 {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
        }
        .header-subtitle {
            font-size: 12px;
            opacity: 0.9;
        }
        .header-actions {
            display: flex;
            gap: 15px;
        }
        .header-action {
            color: var(--white);
            font-size: 20px;
            position: relative;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: var(--white);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--warning-color);
            color: var(--white);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Header Navigation - Only Icons */
        .header-nav {
            display: flex;
            gap: 15px;
            margin-right: 10px;
        }
        .header-nav-item {
            color: var(--white);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            transition: all 0.2s;
        }
        .header-nav-item.active {
            font-weight: bold;
        }
        .header-nav-item i {
            font-size: 20px;
            margin-bottom: 2px;
        }
        /* Search Bar */
        .search-container {
            padding: 10px 15px;
            background-color: var(--primary-color);
            display: none;
        }
        .search-box {
            position: relative;
            background-color: var(--white);
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 8px 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-box i {
            color: #64748b;
            margin-right: 8px;
        }
        .search-box input {
            border: none;
            outline: none;
            flex: 1;
            font-size: 14px;
        }
        /* Banner */
        .banner-container {
            padding: 10px 15px;
            background-color: var(--white);
            margin-bottom: 15px;
        }
        .banner {
            height: 120px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light), var(--accent-color));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            text-align: center;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(19, 78, 74, 0.3);
        }
        .banner-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .banner-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        /* Settings Banner */
        .settings-banner {
            background-color: var(--white);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
        }
        .settings-banner-logo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            margin-right: 15px;
            background-color: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .settings-banner-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .settings-banner-info {
            flex: 1;
        }
        .settings-banner-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--dark-color);
        }
        .settings-banner-subtitle {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 2px;
        }
        .settings-banner-address {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
        }
        .settings-banner-address i {
            margin-right: 5px;
            font-size: 14px;
        }
        /* Dashboard Stats */
        .dashboard-stats {
            padding: 0 15px 15px;
        }
        .stat-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .stat-card {
            flex: 1;
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--card-hover-shadow);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }
        .stat-card.water::before {
            background-color: var(--secondary-color);
        }
        .stat-card.sales::before {
            background-color: var(--primary-color);
        }
        .stat-card.debt::before {
            background-color: var(--warning-color);
        }
        .stat-card.growth::before {
            background-color: var(--success-color);
        }
        .stat-icon { width: 140px; height: 140px; border-radius: 50%; display: flex ; align-items: center; justify-content: center; margin-bottom: 10px; position: absolute; right: -40px; top: -5px; }
        .stat-icon.water {
            background-color: rgba(6, 182, 212, 0.1);
            color: var(--secondary-color);
        }
        .stat-icon.sales {
            background-color: rgba(19, 78, 74, 0.1);
            color: var(--primary-color);
        }
        .stat-icon.debt {
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }
        .stat-icon.growth {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        .stat-value {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .stat-label {
            font-size: 12px;
            color: #64748b;
        }
        .stat-change {
            font-size: 11px;
            margin-top: 5px;
            display: flex;
            align-items: center;
        }
        .stat-change.positive {
            color: var(--success-color);
        }
        .stat-change.negative {
            color: var(--danger-color);
        }
        /* Financial Summary */
        .financial-summary {
            padding: 0 15px 15px;
        }
        .summary-card {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--card-shadow);
        }
        .summary-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .summary-period {
            font-size: 12px;
            color: #64748b;
            font-weight: 400;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .summary-label {
            font-size: 14px;
            color: #64748b;
        }
        .summary-value {
            font-size: 14px;
            font-weight: 500;
        }
        .summary-total {
            border-top: 1px dashed #e2e8f0;
            padding-top: 10px;
            margin-top: 5px;
        }
        .summary-total .summary-label {
            font-weight: 700;
            color: var(--dark-color);
        }
        .summary-total .summary-value {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 16px;
        }
        /* Sales Chart */
        .sales-chart {
            padding: 0 15px 15px;
        }
        .chart-card {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--card-shadow);
        }
        .chart-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chart-period {
            font-size: 12px;
            color: #64748b;
            font-weight: 400;
        }
        .chart-container {
            height: 150px;
            position: relative;
            margin-bottom: 10px;
        }
        .chart-bars {
            display: flex;
            align-items: flex-end;
            height: 100%;
            justify-content: space-between;
            padding: 0 5px;
        }
        .chart-bar {
            width: 12%;
            background: linear-gradient(to top, var(--primary-color), var(--accent-color));
            border-radius: 4px 4px 0 0;
            position: relative;
        }
        .chart-bar::after {
            content: attr(data-value);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 500;
        }
        .chart-labels {
            display: flex;
            justify-content: space-between;
            padding: 0 5px;
        }
        .chart-label {
            font-size: 10px;
            color: #64748b;
            text-align: center;
            width: 12%;
        }
        /* Top Products - Modified to show max 3 products with ranking */
        .top-products {
            padding: 0 15px 15px;
        }
        .products-card {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--card-shadow);
        }
        .top-product-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .top-product-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .top-product-item:last-child {
            border-bottom: none;
        }
        .product-rank {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 12px;
            flex-shrink: 0;
            color: white;
        }
        .product-rank.first {
            background-color: #FFD700; /* Gold */
        }
        .product-rank.second {
            background-color: #C0C0C0; /* Silver */
        }
        .product-rank.third {
            background-color: #CD7F32; /* Bronze */
        }
        .product-info {
            flex: 1;
        }
        .product-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .product-sales {
            font-size: 12px;
            color: #64748b;
        }
        /* Active Customers */
        .active-customers {
            padding: 0 15px 15px;
        }
        .customers-card {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--card-shadow);
        }
        .customer-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .customer-item:last-child {
            border-bottom: none;
        }
        .customer-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: #64748b;
            font-weight: 700;
            flex-shrink: 0;
        }
        .customer-info {
            flex: 1;
        }
        .customer-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
            cursor: pointer;
        }
        .customer-name:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }
        .customer-stats {
            font-size: 12px;
            color: #64748b;
        }
        .customer-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-color);
        }
        /* Recent Transactions */
        .recent-transactions {
            padding: 0 15px 15px;
        }
        .transactions-card {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--card-shadow);
        }
        .transaction-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .transaction-icon.sales {
            background-color: rgba(19, 78, 74, 0.1);
            color: var(--primary-color);
        }
        .transaction-icon.payment {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        .transaction-info {
            flex: 1;
        }
        .transaction-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .transaction-date {
            font-size: 12px;
            color: #64748b;
        }
        .transaction-amount {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-color);
        }
        .transaction-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-top: 4px;
            display: inline-block;
        }
        .status-lunas {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        .status-hutang {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        .status-manual {
            background-color: rgba(6, 182, 212, 0.1);
            color: var(--secondary-color);
        }
        .transaction-actions {
            display: flex;
            gap: 8px;
        }
        .transaction-action {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        .transaction-action:hover {
            background-color: var(--primary-color);
            color: var(--white);
        }
        /* Section */
        .section {
            margin-bottom: 15px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px 10px;
        }
        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--dark-color);
        }
        .section-action {
            font-size: 12px;
            color: var(--primary-color);
        }
        /* Bottom Navigation - Icons above and titles below */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--white);
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -1px 4px rgba(0,0,0,0.1);
            z-index: 100;
        }
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            color: #64748b;
            text-decoration: none;
            transition: color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .nav-item.active {
            color: var(--primary-color);
        }
        .nav-icon {
            font-size: 20px;
            margin-bottom: 0px;
        }
        .nav-label {
            font-size: 10px;
        }
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 70px;
            right: 15px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 5px rgba(19, 78, 74, 0.3);
            font-size: 24px;
            z-index: 99;
        }
        /* Tab Content */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Cashier Style */
        .cashier-container {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin: 15px; /* Changed from 0 15px 15px to 15px */
        }
        .cashier-header {
            background-color: var(--primary-color);
            color: var(--white);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cashier-title {
            font-size: 16px;
            font-weight: 700;
        }
        .cashier-date {
            font-size: 12px;
            opacity: 0.9;
        }
        .cashier-body {
            padding: 15px;
        }
        .customer-selector {
            margin-bottom: 15px;
        }
        .customer-input-container {
            position: relative;
        }
        .customer-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--white);
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }
        .customer-search-results.show {
            display: block;
        }
        .customer-search-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .customer-search-item:hover {
            background-color: #f1f5f9;
        }
        .customer-search-item.selected {
            background-color: rgba(19, 78, 74, 0.1);
        }
        .product-selector {
            margin-bottom: 15px;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .product-item {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .product-item:hover {
            background-color: #f1f5f9;
            transform: translateY(-2px);
        }
        .product-item.selected {
            background-color: rgba(19, 78, 74, 0.1);
            border: 1px solid var(--primary-color);
        }
        .product-icon {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        .product-name {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .product-price {
            font-size: 12px;
            color: var(--primary-color);
            font-weight: 700;
        }
        .product-quantity-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background-color: var(--warning-color);
            color: var(--white);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .cart-items {
            margin-bottom: 15px;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-item-info {
            flex: 1;
        }
        .cart-item-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .cart-item-price {
            font-size: 12px;
            color: #64748b;
        }
        .cart-item-quantity {
            display: flex;
            align-items: center;
            margin-right: 10px;
        }
        .quantity-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }
        .quantity-value {
            margin: 0 10px;
            font-weight: 500;
        }
        .cart-item-total {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-color);
        }
        .cart-summary {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .summary-row.total {
            font-weight: 700;
            font-size: 16px;
            color: var(--primary-color);
            border-top: 1px dashed #cbd5e1;
            padding-top: 5px;
            margin-top: 5px;
        }
        .payment-method {
            margin-bottom: 15px;
        }
        .payment-options {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .payment-option {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            background-color: #f8fafc;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .payment-option:hover {
            background-color: #f1f5f9;
        }
        .payment-option.selected {
            background-color: var(--primary-color);
            color: var(--white);
        }
        .manual-payment-container {
            display: none;
            margin-bottom: 15px;
        }
        .due-date-container {
            display: none;
            margin-bottom: 15px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .action-buttons .btn {
            flex: 1;
        }
        /* Water Stock Report */
        .water-stock-report {
            margin-bottom: 15px;
        }
        .report-card {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 15px;
        }
        .report-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .report-period {
            font-size: 12px;
            color: #64748b;
            font-weight: 400;
        }
        .stock-history {
            margin-bottom: 15px;
        }
        .stock-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .stock-history-item:last-child {
            border-bottom: none;
        }
        .stock-history-info {
            flex: 1;
        }
        .stock-history-date {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 2px;
        }
        .stock-history-desc {
            font-size: 14px;
            font-weight: 500;
        }
        .stock-history-amount {
            font-size: 14px;
            font-weight: 700;
        }
        .stock-history-amount.positive {
            color: var(--success-color);
        }
        .stock-history-amount.negative {
            color: var(--danger-color);
        }
        /* Settings Edit */
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
        }
        .settings-item:last-child {
            border-bottom: none;
        }
        .settings-label {
            font-size: 14px;
            color: var(--dark-color);
        }
        .settings-value-container {
            display: flex;
            align-items: center;
        }
        .settings-value {
            font-size: 14px;
            color: #64748b;
            margin-right: 10px;
        }
        .settings-edit-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 14px;
        }
        /* Notification Dropdown */
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .notification-dropdown.show {
            display: block;
        }
        .notification-dropdown-header {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notification-dropdown-title {
            font-size: 14px;
            font-weight: 700;
        }
        .notification-dropdown-clear {
            font-size: 12px;
            color: var(--primary-color);
            cursor: pointer;
        }
        .notification-dropdown-body {
            padding: 0;
        }
        .notification-dropdown-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .notification-dropdown-item:hover {
            background-color: #f8fafc;
        }
        .notification-dropdown-item:last-child {
            border-bottom: none;
        }
        .notification-dropdown-empty {
            padding: 20px 15px;
            text-align: center;
            color: #64748b;
            font-size: 14px;
        }
        .notification-dropdown-item-info {
            display: flex;
            flex-direction: column;
        }
        .notification-dropdown-item-name {
            font-size: 11px;
            color: var(--dark-color);
            margin-bottom: 2px;
        }
        .notification-dropdown-item-time {
            font-size: 10px;
            color: #94a3b8;
        }
        /* Cart Dropdown */
        .cart-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .cart-dropdown.show {
            display: block;
        }
        .cart-dropdown-header {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cart-dropdown-title {
            font-size: 14px;
            font-weight: 700;
        }
        .cart-dropdown-clear {
            font-size: 12px;
            color: var(--primary-color);
            cursor: pointer;
        }
        .cart-dropdown-body {
            padding: 0;
        }
        .cart-dropdown-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
        }
        .cart-dropdown-item:last-child {
            border-bottom: none;
        }
        .cart-dropdown-empty {
            padding: 20px 15px;
            text-align: center;
            color: #64748b;
            font-size: 14px;
        }
        .cart-dropdown-item-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .cart-dropdown-item-name {
            font-size: 14px;
            font-weight: 500;
        }
        .cart-dropdown-item-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-color);
        }
        .cart-dropdown-item-quantity {
            font-size: 12px;
            color: #64748b;
        }
        .cart-dropdown-footer {
            padding: 12px 15px;
            border-top: 1px solid #f1f5f9;
        }
        .cart-dropdown-summary {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .cart-dropdown-total {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-color);
        }
        /* Receipt Modal - Alfamart Style */
        .receipt-container {
            background-color: var(--white);
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            margin: 0 auto;
            font-family: 'Courier New', monospace;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
        }
        .receipt-header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #e10600; /* Alfamart red color */
            padding-bottom: 15px;
        }
        .receipt-logo {
            width: 60px;
            height: 60px;
            margin: 0 auto 10px;
            border-radius: 50%;
            overflow: hidden;
        }
        .receipt-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .receipt-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #e10600; /* Alfamart red color */
        }
        .receipt-subtitle {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 2px;
        }
        .receipt-info {
            margin-bottom: 15px;
        }
        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .receipt-items {
            margin-bottom: 15px;
        }
        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .receipt-item-name {
            flex: 1;
        }
        .receipt-item-qty {
            width: 30px;
            text-align: right;
        }
        .receipt-item-price {
            width: 60px;
            text-align: right;
        }
        .receipt-total {
            border-top: 2px dashed #e10600; /* Alfamart red color */
            padding-top: 10px;
            margin-top: 10px;
        }
        .receipt-total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .receipt-grand-total {
            font-weight: 700;
            font-size: 14px;
            color: #e10600; /* Alfamart red color */
        }
        .receipt-footer {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e10600; /* Alfamart red color */
            font-size: 11px;
            color: #64748b;
        }
        .receipt-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .receipt-download-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .receipt-download-btn:hover {
            background-color: #45a049;
        }
        /* Loading Spinner */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }
        .spinner-border {
            width: 2rem;
            height: 2rem;
        }
        /* Toast Notification */
        .toast-container {
            position: fixed;
            bottom: 80px;
            right: 15px;
            z-index: 1050;
        }
        .toast {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
            margin-bottom: 10px;
            max-width: 300px;
        }
        .toast-header {
            background-color: var(--primary-color);
            color: var(--white);
            border-bottom: none;
            padding: 8px 12px;
        }
        .toast-body {
            padding: 12px;
        }
        /* Product List/Grid Toggle */
        .view-toggle {
            display: flex;
            justify-content: flex-end;
            padding: 0 15px 10px;
        }
        .view-toggle-btn {
            background: none;
            border: none;
            color: #64748b;
            font-size: 18px;
            margin-left: 10px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .view-toggle-btn.active {
            color: var(--primary-color);
        }
        /* Product List View */
        .product-list {
            padding: 0 15px;
        }
        .product-list-item {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
        }
        .product-list-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-hover-shadow);
        }
        .product-list-item.selected {
            background-color: rgba(19, 78, 74, 0.1);
            border-left: 4px solid var(--primary-color);
        }
        .product-list-icon {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .product-list-icon i {
            font-size: 24px;
            color: var(--primary-color);
        }
        .product-list-info {
            flex: 1;
        }
        .product-list-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        .product-list-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .product-list-stock {
            font-size: 12px;
            color: #64748b;
        }
        .product-list-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-color);
        }
        .product-list-quantity {
            position: absolute;
            top: 10px;
            right: 15px;
            background-color: var(--warning-color);
            color: var(--white);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        /* Product Grid View */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 0 15px;
        }
        .product-card {
            background-color: var(--white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--card-hover-shadow);
        }
        .product-image {
            height: 120px;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .product-image i {
            font-size: 40px;
            color: #cbd5e1;
        }
        .product-info {
            padding: 10px;
        }
        .product-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .product-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }
        .product-stock {
            font-size: 11px;
            color: #64748b;
        }
        /* Other Tabs (unchanged) */
        .card-container {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin: 0 15px 15px;
        }
        .card-list {
            padding: 0;
            margin: 0;
            list-style: none;
        }
        .card-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
        }
        .card-item:last-child {
            border-bottom: none;
        }
        .card-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            background-color: rgba(19, 78, 74, 0.1);
            color: var(--primary-color);
        }
        .card-content {
            flex: 1;
        }
        .card-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .card-subtitle {
            font-size: 12px;
            color: #64748b;
        }
        .card-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--dark-color);
        }
        .customer-actions {
            display: flex;
            gap: 8px;
        }
        .customer-action {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .customer-action:hover {
            transform: scale(1.1);
        }
        .customer-action.whatsapp {
            color: #25D366;
        }
        .customer-action.location {
            color: #EA4335;
        }
        .water-stock-container {
            padding: 15px;
        }
        .water-tank {
            height: 400px;
            background-color: var(--white);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }
        .tank-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            text-align: center;
        }
        .tank-container {
            height: 230px;
            background-color: #000;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        .water-level {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--secondary-color), var(--accent-color));
            border-radius: 0 0 8px 8px;
            transition: height 1s ease;
        }
        .water-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: 700;
            color: var(--white);
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .water-info {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        .water-stat {
            text-align: center;
        }
        .water-stat-value {
            font-size: 14px;
            font-weight: 700;
        }
        .water-stat-label {
            font-size: 11px;
            color: #64748b;
        }
        .water-stock-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .water-stock-box {
            background-color: var(--white);
            border-radius: 8px;
            padding: 12px;
            box-shadow: var(--card-shadow);
            text-align: center;
        }
        .water-stock-box-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 4px;
        }
        .water-stock-box-label {
            font-size: 11px;
            color: #64748b;
        }
        .expense-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
        }
        .expense-item:last-child {
            border-bottom: none;
        }
        .expense-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        .expense-info {
            flex: 1;
        }
        .expense-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .expense-date {
            font-size: 12px;
            color: #64748b;
        }
        .expense-amount {
            font-size: 14px;
            font-weight: 700;
            color: var(--danger-color);
        }
        .expense-type {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: #f1f5f9;
            margin-top: 4px;
            display: inline-block;
        }
        .settings-container {
            padding: 15px;
        }
        .settings-group {
            background-color: var(--white);
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        .settings-group-title {
            font-size: 14px;
            font-weight: 700;
            padding: 12px 15px;
            background-color: #f8fafc;
            border-bottom: 1px solid #f1f5f9;
        }
        .settings-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .settings-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        /* Menu Settings Styles */
        .menu-settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f1f5f9;
        }
        .menu-settings-item:last-child {
            border-bottom: none;
        }
        .menu-settings-info {
            flex: 1;
        }
        .menu-settings-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 2px;
        }
        .menu-settings-description {
            font-size: 12px;
            color: #64748b;
        }
        .menu-settings-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .menu-position-selector {
            display: flex;
            background-color: #f1f5f9;
            border-radius: 6px;
            overflow: hidden;
        }
        .menu-position-option {
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .menu-position-option.active {
            background-color: var(--primary-color);
            color: var(--white);
        }
        /* Reset and Backup Styles */
        .settings-action-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding: 0 15px;
        }
        .settings-action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .settings-action-btn.reset {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        .settings-action-btn.reset:hover {
            background-color: rgba(239, 68, 68, 0.2);
        }
        .settings-action-btn.backup {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }
        .settings-action-btn.backup:hover {
            background-color: rgba(16, 185, 129, 0.2);
        }
        .settings-action-btn.import {
            background-color: rgba(6, 182, 212, 0.1);
            color: var(--secondary-color);
        }
        .settings-action-btn.import:hover {
            background-color: rgba(6, 182, 212, 0.2);
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            flex: 1;
        }
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        /* Receipt Footer Settings */
        .receipt-footer-settings {
            margin-top: 15px;
        }
        .receipt-footer-preview {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #64748b;
            font-style: italic;
        }
        /* Modal Content */
        .modal-content {
            border-radius: 12px;
            border: none;
        }
        .modal-header {
            border-bottom: 1px solid #f1f5f9;
            padding: 15px;
        }
        .modal-title {
            font-size: 16px;
            font-weight: 700;
        }
        .modal-body {
            padding: 15px;
        }
        .modal-footer {
            border-top: 1px solid #f1f5f9;
            padding: 15px;
        }
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            padding: 10px 12px;
            font-size: 14px;
        }
        .form-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .btn {
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* Maps Modal */
        .maps-modal-body {
            padding: 0;
        }
        .maps-container {
            width: 100%;
            height: 400px;
            position: relative;
        }
        .maps-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        /* Debt Payment Styles */
        .debt-container {
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            margin: 0 15px 15px;
        }
        .debt-header {
            background-color: var(--warning-color);
            color: var(--white);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .debt-title {
            font-size: 16px;
            font-weight: 700;
        }
        .debt-body {
            padding: 15px;
        }
        .debt-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .debt-item:last-child {
            border-bottom: none;
        }
        .debt-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            background-color: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }
        .debt-info {
            flex: 1;
        }
        .debt-title-text {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }
        .debt-date {
            font-size: 12px;
            color: #64748b;
        }
        .debt-amount {
            font-size: 14px;
            font-weight: 700;
            color: var(--warning-color);
        }
        .debt-due-date {
            font-size: 12px;
            color: var(--danger-color);
            margin-top: 4px;
        }
        .debt-actions {
            display: flex;
            gap: 8px;
        }
        .debt-action {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            cursor: pointer;
            transition: all 0.2s;
        }
        .debt-action:hover {
            background-color: var(--primary-color);
            color: var(--white);
        }
        .debt-action.pay {
            color: var(--success-color);
        }
        .debt-action.pay:hover {
            background-color: var(--success-color);
            color: var(--white);
        }
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 15px;
        }
        .tab-navigation-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            color: #64748b;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .tab-navigation-item.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content-container {
            display: none;
        }
        .tab-content-container.active {
            display: block;
        }
        /* Responsive */
        @media (max-width: 410px) {
            .stat-row {
                flex-direction: column;
            }
            
            .product-grid {
                grid-template-columns: 1fr;
            }
            
            .notification-dropdown, .cart-dropdown {
                width: 280px;
            }
            
            .water-stock-details {
                grid-template-columns: 1fr;
            }
        }
        
        /* Animasi rotasi untuk ikon refresh */
        .rotating {
            animation: rotate 1s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Processing Overlay - Baru -->
    <div class="processing-overlay" id="processing-overlay">
        <div class="processing-content">
            <div class="processing-spinner"></div>
            <div class="processing-text">Sedang Diproses</div>
        </div>
    </div>
    <!-- Header -->
    <div class="app-header" id="app-header">
        <div class="header-logo" id="header-logo">
            <i class="bi bi-droplet-fill"></i>
        </div>
        <div class="header-title">
            <h1 id="app-title">YOUSHE</h1>
            <div class="header-subtitle" id="app-subtitle">Depot Air Minum Isi Ulang</div>
        </div>
         <!-- Header Navigation - Only Icons -->
        <div class="header-nav" id="header-nav">
            <!-- Header nav items will be added dynamically -->
        </div>
        <div class="header-actions">
            <div class="header-action" id="notification-bell">
                <i class="bi bi-bell"></i>
                <span class="notification-badge" id="notification-count">0</span>
                <div class="notification-dropdown" id="notification-dropdown">
                    <div class="notification-dropdown-header">
                        <div class="notification-dropdown-title">Notifikasi</div>
                        <div class="notification-dropdown-clear" id="clear-notifications">Hapus Semua</div>
                    </div>
                    <div class="notification-dropdown-body" id="notification-dropdown-body">
                        <!-- Notifications will be loaded dynamically -->
                        <div class="notification-dropdown-empty">Tidak ada notifikasi</div>
                    </div>
                </div>
            </div>
            <div class="header-action" id="cart-icon">
                <i class="bi bi-cart3"></i>
                <span class="cart-badge" id="cart-count">0</span>
                <div class="cart-dropdown" id="cart-dropdown">
                    <div class="cart-dropdown-header">
                        <div class="cart-dropdown-title">Keranjang Belanja</div>
                        <div class="cart-dropdown-clear" id="clear-cart">Kosongkan</div>
                    </div>
                    <div class="cart-dropdown-body" id="cart-dropdown-body">
                        <!-- Cart items will be loaded dynamically -->
                        <div class="cart-dropdown-empty">Keranjang kosong</div>
                    </div>
                    <div class="cart-dropdown-footer">
                        <div class="cart-dropdown-summary">
                            <div>Total:</div>
                            <div class="cart-dropdown-total" id="cart-dropdown-total">Rp 0</div>
                        </div>
                        <button class="btn btn-primary w-100" id="cart-checkout-btn">Checkout</button>
                    </div>
                </div>
            </div>
            <div class="header-action" id="settings-icon">
                <i class="bi bi-gear"></i>
            </div>
        </div>
       
    </div>
    <!-- Search Bar -->
    <div class="search-container" id="search-container">
        <div class="search-box">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Cari produk, pelanggan, atau transaksi..." id="search-input">
        </div>
    </div>
    <!-- Banner -->
    <div class="banner-container" id="banner-container">
        <div class="banner">
            <div>
                <div class="banner-title" id="monthly-revenue">Rp. 0</div>
                <div class="banner-subtitle">Omset Pemasukan Bulan Ini</div>
            </div>
        </div>
    </div>
    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content active">
        <!-- Stats Cards -->
        <div class="dashboard-stats">
            <div class="stat-row">
                <div class="stat-card water">
                    <div class="stat-icon water">
                        <i class="bi bi-droplet-fill"></i>
                    </div>
                    <div class="stat-value" id="water-stock">0 L</div>
                    <div class="stat-label">Stok Air</div>
                    <div class="stat-change negative" id="water-stock-change">
                        <i class="bi bi-arrow-down"></i> 0% dari kemarin
                    </div>
                </div>
                <div class="stat-card sales">
                    <div class="stat-icon sales">
                        <i class="bi bi-cash-stack"></i>
                    </div>
                    <div class="stat-value" id="today-sales">Rp 0</div>
                    <div class="stat-label">Penjualan Hari Ini</div>
                    <div class="stat-change positive" id="today-sales-change">
                        <i class="bi bi-arrow-up"></i> 0% dari kemarin
                    </div>
                </div>
            </div>
            <div class="stat-row">
                <div class="stat-card debt">
                    <div class="stat-icon debt">
                        <i class="bi bi-wallet2"></i>
                    </div>
                    <div class="stat-value" id="outstanding-debt">Rp 0</div>
                    <div class="stat-label">Hutang Belum Lunas</div>
                    <div class="stat-change negative" id="outstanding-debt-change">
                        <i class="bi bi-arrow-up"></i> 0% dari kemarin
                    </div>
                </div>
                <div class="stat-card growth">
                    <div class="stat-icon growth">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="stat-value" id="growth-rate">0%</div>
                    <div class="stat-label">Pertumbuhan Bulan Ini</div>
                    <div class="stat-change positive" id="growth-rate-change">
                        <i class="bi bi-arrow-up"></i> 0% dari bulan lalu
                    </div>
                </div>
            </div>
        </div>
        <!-- Financial Summary -->
        <div class="financial-summary">
            <div class="summary-card">
                <div class="summary-title">
                    Ringkasan Keuangan
                    <span class="summary-period">Bulan Ini</span>
                </div>
                <div class="summary-row">
                    <div class="summary-label">Total Pendapatan</div>
                    <div class="summary-value" id="total-income">Rp 0</div>
                </div>
                <div class="summary-row">
                    <div class="summary-label">Total Pengeluaran</div>
                    <div class="summary-value" id="total-expense">Rp 0</div>
                </div>
                <div class="summary-row">
                    <div class="summary-label">Total Hutang</div>
                    <div class="summary-value" id="total-debt">Rp 0</div>
                </div>
                <div class="summary-row summary-total">
                    <div class="summary-label">Laba Bersih</div>
                    <div class="summary-value" id="net-profit">Rp 0</div>
                </div>
            </div>
        </div>
        <!-- Sales Chart -->
        <div class="sales-chart">
            <div class="chart-card">
                <div class="chart-title">
                    Grafik Penjualan
                    <span class="chart-period">7 Hari Terakhir</span>
                </div>
                <div class="chart-container">
                    <div class="chart-bars" id="sales-chart-bars">
                        <!-- Chart bars will be generated dynamically -->
                    </div>
                </div>
                <div class="chart-labels">
                    <div class="chart-label">Sen</div>
                    <div class="chart-label">Sel</div>
                    <div class="chart-label">Rab</div>
                    <div class="chart-label">Kam</div>
                    <div class="chart-label">Jum</div>
                    <div class="chart-label">Sab</div>
                    <div class="chart-label">Min</div>
                </div>
            </div>
        </div>
        <!-- Top Products - Modified to show max 3 products with ranking -->
        <div class="top-products">
            <div class="section-header">
                <div class="section-title">Produk Terlaris</div>
                <a href="#" class="section-action">Lihat Semua</a>
            </div>
            <div class="products-card" id="top-products-container">
                <!-- Top products will be loaded dynamically -->
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Active Customers -->
        <div class="active-customers">
            <div class="section-header">
                <div class="section-title">Riwayat Belanjaan Pelanggan</div>
                <a href="#" class="section-action">Lihat Semua</a>
            </div>
            <div class="customers-card" id="active-customers-container">
                <!-- Active customers will be loaded dynamically -->
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Recent Transactions -->
        <div class="recent-transactions">
            <div class="section-header">
                <div class="section-title">Transaksi Terbaru</div>
                <a href="#" class="section-action">Lihat Semua</a>
            </div>
            <div class="transactions-card" id="recent-transactions-container">
                <!-- Recent transactions will be loaded dynamically -->
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Transaksi Tab -->
    <div id="transaksi-tab" class="tab-content">
        <!-- Cashier Style Transaction -->
        <div class="cashier-container">
            <div class="cashier-header">
                <div class="cashier-title">Transaksi Baru</div>
                <div class="cashier-date" id="transaction-date"></div>
            </div>
            <div class="cashier-body">
                <div class="customer-selector">
                    <label class="form-label">Pelanggan</label>
                    <div class="customer-input-container">
                        <input type="text" class="form-control" id="cashier-customer-input" placeholder="Cari atau tambah pelanggan baru">
                        <div class="customer-search-results" id="customer-search-results">
                            <!-- Customer search results will be loaded dynamically -->
                        </div>
                    </div>
                </div>
                
                <div class="cart-items">
                    <label class="form-label">Item Pembelian</label>
                    <div id="cart-items-container">
                        <div class="text-center text-muted py-3">Belum ada item yang dipilih</div>
                    </div>
                </div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <div>Subtotal</div>
                        <div id="cart-subtotal">Rp 0</div>
                    </div>
                    <div class="summary-row">
                        <div>Diskon</div>
                        <div id="cart-discount">Rp 0</div>
                    </div>
                    <div class="summary-row total">
                        <div>Total</div>
                        <div id="cart-total">Rp 0</div>
                    </div>
                </div>
                
                <div class="payment-method">
                    <label class="form-label">Metode Pembayaran</label>
                    <div class="payment-options">
                        <div class="payment-option selected" data-payment="Lunas">
                            <i class="bi bi-cash"></i>
                            <div>Lunas</div>
                        </div>
                        <div class="payment-option" data-payment="Hutang">
                            <i class="bi bi-wallet2"></i>
                            <div>Hutang</div>
                        </div>
                        <div class="payment-option" data-payment="Manual">
                            <i class="bi bi-hand-index-thumb"></i>
                            <div>Manual</div>
                        </div>
                    </div>
                    
                    <div class="manual-payment-container" id="manual-payment-container">
                        <label class="form-label">Jumlah Bayar (Rp)</label>
                        <input type="number" class="form-control" id="manual-payment-amount" placeholder="Masukkan jumlah bayar">
                    </div>
                    
                    <div class="due-date-container" id="due-date-container">
                        <label class="form-label">Tanggal Jatuh Tempo</label>
                        <input type="date" class="form-control" id="transaction-due-date">
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="clear-cart-btn">Batal</button>
                    <button class="btn btn-primary" id="checkout-btn">Bayar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Riwayat Transaksi Tab -->
    <div id="riwayat-tab" class="tab-content">
        <div class="section">
            <div class="section-header">
                <div class="section-title">Riwayat Transaksi</div>
                <a href="#" class="section-action">Filter</a>
            </div>
            
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <div class="tab-navigation-item active" data-tab="transaction-history-tab">
                    Riwayat Transaksi
                </div>
                <div class="tab-navigation-item" data-tab="debt-tab">
                    Hutang
                </div>
            </div>
            
            <!-- Transaction History Tab Content -->
            <div id="transaction-history-tab" class="tab-content-container active">
                <div class="card-container">
                    <ul class="card-list" id="transaction-history-list">
                        <!-- Transaction history will be loaded dynamically -->
                        <div class="spinner-container">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </ul>
                </div>
            </div>
            
            <!-- Debt Tab Content -->
            <div id="debt-tab" class="tab-content-container">
                <div class="debt-container">
                    <div class="debt-header">
                        <div class="debt-title">Daftar Hutang</div>
                    </div>
                    <div class="debt-body" id="debt-list-container">
                        <!-- Debt list will be loaded dynamically -->
                        <div class="spinner-container">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Produk Tab -->
    <div id="produk-tab" class="tab-content">
        <div class="section">
            <div class="section-header">
                <div class="section-title">Daftar Produk</div>
                <a href="#" class="section-action">Filter</a>
            </div>
            <!-- Product List/Grid Toggle -->
            <div class="view-toggle">
                <button class="view-toggle-btn active" id="list-view-btn" title="Tampilan List">
                    <i class="bi bi-list"></i>
                </button>
                <button class="view-toggle-btn" id="grid-view-btn" title="Tampilan Grid">
                    <i class="bi bi-grid-3x3-gap"></i>
                </button>
            </div>
            <!-- Product List View (Default) -->
            <div class="product-list" id="product-list-container">
                <!-- Products will be loaded dynamically -->
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <!-- Product Grid View (Hidden by default) -->
            <div class="product-grid" id="product-grid-container" style="display: none;">
                <!-- Products will be loaded dynamically -->
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add Product Button -->
        <div class="d-grid gap-2 p-3" id="add-product-section">
            <button class="btn btn-success" id="checkout-products-btn" style="display: none;">
                <i class="bi bi-cart-check"></i> Checkout
            </button>
        </div>
    </div>
    <!-- Pelanggan Tab -->
    <div id="pelanggan-tab" class="tab-content">
        <div class="section">
            <div class="section-header">
                <div class="section-title">Daftar Pelanggan</div>
                <a href="#" class="section-action">Filter</a>
            </div>
            <div class="card-container" id="customers-container" style="margin: 0 15px 15px; padding: 0 10px;">
                <!-- Customers will be loaded dynamically -->
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Stok Air Tab -->
    <div id="stok-tab" class="tab-content">
        <div class="water-stock-container">
            <div class="water-tank">
                <div class="tank-label">Stok Air Saat Ini</div>
                <div class="tank-container">
                    <div class="water-level" id="water-level"></div>
                    <div class="water-percentage" id="water-percentage">0%</div>
                </div>
                <div class="water-info">
                    <div class="water-stat">
                        <div class="water-stat-value" id="remaining-water">0 L</div>
                        <div class="water-stat-label">Sisa Stok</div>
                    </div>
                    <div class="water-stat">
                        <div class="water-stat-value" id="used-water">0 L</div>
                        <div class="water-stat-label">Terpakai Hari Ini</div>
                    </div>
                    <div class="water-stat">
                        <div class="water-stat-value" id="tank-capacity">0 L</div>
                        <div class="water-stat-label">Kapasitas</div>
                    </div>
                </div>
            </div>
            
            <!-- Water Stock Details -->
            <div class="water-stock-details">
                <div class="water-stock-box">
                    <div class="water-stock-box-value" id="detail-remaining-water">0 L</div>
                    <div class="water-stock-box-label">Sisa Stok</div>
                </div>
                <div class="water-stock-box">
                    <div class="water-stock-box-value" id="detail-used-water">0 L</div>
                    <div class="water-stock-box-label">Liter Terpakai</div>
                </div>
                <div class="water-stock-box">
                    <div class="water-stock-box-value" id="detail-total-used-water">0 L</div>
                    <div class="water-stock-box-label">Total Liter Terpakai</div>
                </div>
                <div class="water-stock-box">
                    <div class="water-stock-box-value" id="detail-tank-capacity">0 L</div>
                    <div class="water-stock-box-label">Kapasitas Toren</div>
                </div>
                <div class="water-stock-box">
                    <div class="water-stock-box-value" id="detail-total-cost">Rp 0</div>
                    <div class="water-stock-box-label">Total Biaya Suplai (Rp)</div>
                </div>
            </div>
            
            <!-- Water Stock Report -->
            <div class="water-stock-report">
                <div class="report-card">
                    <div class="report-title">
                        Riwayat Penambahan Stok Air
                        <span class="report-period">30 Hari Terakhir</span>
                    </div>
                    <div class="stock-history" id="stock-history-container">
                        <!-- Stock history will be loaded dynamically -->
                        <div class="spinner-container">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-grid gap-2 mt-3">
                <button class="btn btn-primary" id="refill-water-btn" data-bs-toggle="modal" data-bs-target="#refillModal" disabled>
                    <i class="bi bi-arrow-repeat"></i> Tambah Stok Air
                </button>
            </div>
        </div>
    </div>
    <!-- Pengeluaran Tab -->
    <div id="pengeluaran-tab" class="tab-content">
        <div class="section">
            <div class="section-header">
                <div class="section-title">Pengeluaran Bulan Ini</div>
                <a href="#" class="section-action">Lihat Semua</a>
            </div>
            <div class="banner-container">
                <div class="banner">
                    <div>
                        <div class="banner-title" id="monthly-expense">Rp. 0</div>
                        <div class="banner-subtitle">Total Pengeluaran Bulan Ini</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <div class="card-container" id="expenses-container">
                <!-- Expenses will be loaded dynamically -->
                <div class="spinner-container">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Pengaturan Tab -->
    <div id="pengaturan-tab" class="tab-content">
        <!-- Settings Banner -->
        <div class="settings-banner">
            <div class="settings-banner-logo">
                <img src="https://forumu.github.io/gen/logo.png" alt="Logo" id="settings-banner-logo">
            </div>
            <div class="settings-banner-info">
                <div class="settings-banner-title" id="settings-banner-title">YOUSHE</div>
                <div class="settings-banner-subtitle" id="settings-banner-subtitle">Depot Air Minum Isi Ulang</div>
                <div class="settings-banner-address">
                    <i class="bi bi-geo-alt"></i>
                    <span id="settings-banner-address">Jaten Karanganyar</span>
                </div>
            </div>
        </div>
        
        <div class="settings-container">
            <div class="settings-group">
                <div class="settings-group-title">Informasi Usaha</div>
                <div class="settings-item">
                    <div class="settings-label">Nama Usaha</div>
                    <div class="settings-value-container">
                        <div class="settings-value" id="business-name">YOUSHE</div>
                        <button class="settings-edit-btn" data-field="Nama Usaha" data-value="YOUSHE">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Alamat Usaha</div>
                    <div class="settings-value-container">
                        <div class="settings-value" id="business-address">Jaten Karanganyar</div>
                        <button class="settings-edit-btn" data-field="Alamat Usaha" data-value="Jaten Karanganyar">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Kontak</div>
                    <div class="settings-value-container">
                        <div class="settings-value" id="business-contact">+6285867271777</div>
                        <button class="settings-edit-btn" data-field="Kontak" data-value="+6285867271777">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Logo</div>
                    <div class="settings-value-container">
                        <div class="settings-value" id="business-logo">https://forumu.github.io/gen/logo.png</div>
                        <button class="settings-edit-btn" data-field="Logo" data-value="https://forumu.github.io/gen/logo.png">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="settings-group-title">Pengaturan Air</div>
                <div class="settings-item">
                    <div class="settings-label">Kapasitas Toren</div>
                    <div class="settings-value-container">
                        <div class="settings-value" id="tank-capacity-setting">8000 Liter</div>
                        <button class="settings-edit-btn" data-field="Kapasitas Toren (Liter)" data-value="8000">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Biaya Suplai Air</div>
                    <div class="settings-value-container">
                        <div class="settings-value" id="water-supply-cost">Rp 300000</div>
                        <button class="settings-edit-btn" data-field="Biaya Suplai Air Tangki (Rp)" data-value="300000">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="settings-group-title">Pengaturan Nota</div>
                <div class="settings-item">
                    <div class="settings-label">Footer Nota</div>
                    <div class="settings-value-container">
                        <div class="settings-value" id="receipt-footer-setting">Terima kasih atas kunjungan Anda</div>
                        <button class="settings-edit-btn" data-field="Footer Nota" data-value="Terima kasih atas kunjungan Anda">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
                <div class="receipt-footer-settings">
                    <div class="receipt-footer-preview" id="receipt-footer-preview">
                        Terima kasih atas kunjungan Anda
                    </div>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="settings-group-title">Pengaturan Menu</div>
                <div class="menu-settings-item">
                    <div class="menu-settings-info">
                        <div class="menu-settings-label">Menu Beranda</div>
                        <div class="menu-settings-description">Tampilkan menu beranda di navigasi</div>
                    </div>
                    <div class="menu-settings-controls">
                        <label class="settings-toggle">
                            <input type="checkbox" class="menu-toggle" data-menu="dashboard-tab" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="menu-position-selector">
                            <div class="menu-position-option active" data-position="bottom">Bawah</div>
                            <div class="menu-position-option" data-position="header">Atas</div>
                        </div>
                    </div>
                </div>
                <div class="menu-settings-item">
                    <div class="menu-settings-info">
                        <div class="menu-settings-label">Menu Transaksi</div>
                        <div class="menu-settings-description">Tampilkan menu transaksi di navigasi</div>
                    </div>
                    <div class="menu-settings-controls">
                        <label class="settings-toggle">
                            <input type="checkbox" class="menu-toggle" data-menu="transaksi-tab" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="menu-position-selector">
                            <div class="menu-position-option active" data-position="bottom">Bawah</div>
                            <div class="menu-position-option" data-position="header">Atas</div>
                        </div>
                    </div>
                </div>
                <div class="menu-settings-item">
                    <div class="menu-settings-info">
                        <div class="menu-settings-label">Menu Riwayat</div>
                        <div class="menu-settings-description">Tampilkan menu riwayat di navigasi</div>
                    </div>
                    <div class="menu-settings-controls">
                        <label class="settings-toggle">
                            <input type="checkbox" class="menu-toggle" data-menu="riwayat-tab" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="menu-position-selector">
                            <div class="menu-position-option active" data-position="bottom">Bawah</div>
                            <div class="menu-position-option" data-position="header">Atas</div>
                        </div>
                    </div>
                </div>
                <div class="menu-settings-item">
                    <div class="menu-settings-info">
                        <div class="menu-settings-label">Menu Produk</div>
                        <div class="menu-settings-description">Tampilkan menu produk di navigasi</div>
                    </div>
                    <div class="menu-settings-controls">
                        <label class="settings-toggle">
                            <input type="checkbox" class="menu-toggle" data-menu="produk-tab" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="menu-position-selector">
                            <div class="menu-position-option active" data-position="bottom">Bawah</div>
                            <div class="menu-position-option" data-position="header">Atas</div>
                        </div>
                    </div>
                </div>
                <div class="menu-settings-item">
                    <div class="menu-settings-info">
                        <div class="menu-settings-label">Menu Pelanggan</div>
                        <div class="menu-settings-description">Tampilkan menu pelanggan di navigasi</div>
                    </div>
                    <div class="menu-settings-controls">
                        <label class="settings-toggle">
                            <input type="checkbox" class="menu-toggle" data-menu="pelanggan-tab" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="menu-position-selector">
                            <div class="menu-position-option active" data-position="bottom">Bawah</div>
                            <div class="menu-position-option" data-position="header">Atas</div>
                        </div>
                    </div>
                </div>
                <div class="menu-settings-item">
                    <div class="menu-settings-info">
                        <div class="menu-settings-label">Menu Stok Air</div>
                        <div class="menu-settings-description">Tampilkan menu stok air di navigasi</div>
                    </div>
                    <div class="menu-settings-controls">
                        <label class="settings-toggle">
                            <input type="checkbox" class="menu-toggle" data-menu="stok-tab" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="menu-position-selector">
                            <div class="menu-position-option active" data-position="bottom">Bawah</div>
                            <div class="menu-position-option" data-position="header">Atas</div>
                        </div>
                    </div>
                </div>
                <div class="menu-settings-item">
                    <div class="menu-settings-info">
                        <div class="menu-settings-label">Menu Pengeluaran</div>
                        <div class="menu-settings-description">Tampilkan menu pengeluaran di navigasi</div>
                    </div>
                    <div class="menu-settings-controls">
                        <label class="settings-toggle">
                            <input type="checkbox" class="menu-toggle" data-menu="pengeluaran-tab" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="menu-position-selector">
                            <div class="menu-position-option active" data-position="bottom">Bawah</div>
                            <div class="menu-position-option" data-position="header">Atas</div>
                        </div>
                    </div>
                </div>
                <div class="menu-settings-item">
                    <div class="menu-settings-info">
                        <div class="menu-settings-label">Menu Pengaturan</div>
                        <div class="menu-settings-description">Tampilkan menu pengaturan di navigasi</div>
                    </div>
                    <div class="menu-settings-controls">
                        <label class="settings-toggle">
                            <input type="checkbox" class="menu-toggle" data-menu="pengaturan-tab" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <div class="menu-position-selector">
                            <div class="menu-position-option active" data-position="bottom">Bawah</div>
                            <div class="menu-position-option" data-position="header">Atas</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="settings-group-title">Notifikasi</div>
                <div class="settings-item">
                    <div class="settings-label">Notifikasi Sistem</div>
                    <label class="settings-toggle">
                        <input type="checkbox" id="system-notification-toggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="settings-group-title">API Key</div>
                <div class="settings-item">
                    <div class="settings-label">Kunci API</div>
                    <div class="settings-value-container">
                        <div class="settings-value" id="api-key-setting">AKfycby_6VvnaHFQ4hmJALaX5-Zk1bF-nHzyuGR_FfdDvtJfbu_YMWLsVycoCrtCT-DlyMAv</div>
                        <button class="settings-edit-btn" data-field="API" data-value="AKfycby_6VvnaHFQ4hmJALaX5-Zk1bF-nHzyuGR_FfdDvtJfbu_YMWLsVycoCrtCT-DlyMAv">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Reset and Backup Settings -->
            <div class="settings-action-group">
                <div class="settings-action-btn reset" id="reset-data-btn">
                    <i class="bi bi-arrow-clockwise"></i>
                    Reset Data
                </div>
                <div class="settings-action-btn backup" id="backup-settings-btn">
                    <i class="bi bi-download"></i>
                    Backup Pengaturan
                </div>
            </div>
            
            <div class="settings-action-group">
                <div class="file-input-wrapper">
                    <div class="settings-action-btn import">
                        <i class="bi bi-upload"></i>
                        Import Backup
                    </div>
                    <input type="file" id="import-backup-input" accept=".json">
                </div>
            </div>
        </div>
    </div>
    <!-- Bottom Navigation - Icons above and titles below -->
    <div class="bottom-nav" id="bottom-nav">
        <a href="#" class="nav-item active" data-tab="dashboard-tab">
            <div class="nav-icon"><i class="bi bi-house-door"></i></div>
            <div class="nav-label">Beranda</div>
        </a>
        <a href="#" class="nav-item" data-tab="transaksi-tab">
            <div class="nav-icon"><i class="bi bi-receipt"></i></div>
            <div class="nav-label">Transaksi</div>
        </a>
        <a href="#" class="nav-item" data-tab="riwayat-tab">
            <div class="nav-icon"><i class="bi bi-clock-history"></i></div>
            <div class="nav-label">Riwayat</div>
        </a>
        <a href="#" class="nav-item" data-tab="produk-tab">
            <div class="nav-icon"><i class="bi bi-box-seam"></i></div>
            <div class="nav-label">Produk</div>
        </a>
        <a href="#" class="nav-item" data-tab="pelanggan-tab">
            <div class="nav-icon"><i class="bi bi-people"></i></div>
            <div class="nav-label">Pelanggan</div>
        </a>
        <a href="#" class="nav-item" data-tab="stok-tab">
            <div class="nav-icon"><i class="bi bi-droplet"></i></div>
            <div class="nav-label">Stok Air</div>
        </a>
        <a href="#" class="nav-item" data-tab="pengeluaran-tab">
            <div class="nav-icon"><i class="bi bi-cash-coin"></i></div>
            <div class="nav-label">Pengeluaran</div>
        </a>
        <a href="#" class="nav-item" data-tab="pengaturan-tab">
            <div class="nav-icon"><i class="bi bi-gear"></i></div>
            <div class="nav-label">Pengaturan</div>
        </a>
    </div>
    <!-- Floating Action Button - Dynamic based on active tab -->
    <a href="#" class="fab" id="fab-button">
        <i class="bi bi-arrow-clockwise"></i>
    </a>
    <!-- Add Transaction Modal -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Transaksi Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Pelanggan</label>
                        <select class="form-select" id="transaction-customer-select">
                            <option selected>Pilih pelanggan</option>
                            <!-- Customers will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Produk</label>
                        <select class="form-select" id="transaction-product-select">
                            <option selected>Pilih produk</option>
                            <!-- Products will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jumlah</label>
                        <input type="number" class="form-control" id="transaction-quantity" placeholder="Jumlah produk" value="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status Pembayaran</label>
                        <select class="form-select" id="transaction-payment-status">
                            <option value="Lunas" selected>Lunas</option>
                            <option value="Hutang">Hutang</option>
                            <option value="Manual">Manual</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tanggal Jatuh Tempo</label>
                        <input type="date" class="form-control" id="transaction-due-date">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-transaction-modal-btn">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Produk</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nama Produk</label>
                        <input type="text" class="form-control" id="product-name" placeholder="Nama produk">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Liter</label>
                        <input type="number" class="form-control" id="product-liter" placeholder="Jumlah liter">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Harga Pokok (Rp)</label>
                        <input type="number" class="form-control" id="product-cost" placeholder="Harga pokok per produk">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Harga Jual (Rp)</label>
                        <input type="number" class="form-control" id="product-price" placeholder="Harga jual per produk">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-product-btn">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Add Customer Modal -->
    <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Pelanggan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nama Pelanggan</label>
                        <input type="text" class="form-control" id="customer-name" placeholder="Nama pelanggan">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kontak</label>
                        <input type="text" class="form-control" id="customer-contact" placeholder="Nomor telepon">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Alamat</label>
                        <textarea class="form-control" id="customer-address" rows="2" placeholder="Alamat lengkap"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Galon Titipan</label>
                        <input type="number" class="form-control" id="customer-deposit" placeholder="Jumlah galon titipan" value="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Google Maps Link</label>
                        <input type="text" class="form-control" id="customer-maps" placeholder="Link Google Maps">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-customer-btn">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Customer Modal -->
    <div class="modal fade" id="editCustomerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Pelanggan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-customer-id">
                    <div class="mb-3">
                        <label class="form-label">Nama Pelanggan</label>
                        <input type="text" class="form-control" id="edit-customer-name" placeholder="Nama pelanggan">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kontak</label>
                        <input type="text" class="form-control" id="edit-customer-contact" placeholder="Nomor telepon">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Alamat</label>
                        <textarea class="form-control" id="edit-customer-address" rows="2" placeholder="Alamat lengkap"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Galon Titipan</label>
                        <input type="number" class="form-control" id="edit-customer-deposit" placeholder="Jumlah galon titipan" value="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Google Maps Link</label>
                        <input type="text" class="form-control" id="edit-customer-maps" placeholder="Link Google Maps">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="delete-customer-btn">Hapus</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-customer-name-btn">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Add Expense Modal -->
    <div class="modal fade" id="addExpenseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tambah Pengeluaran</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Jenis Pengeluaran</label>
                        <select class="form-select" id="expense-type">
                            <option value="Operasional">Operasional</option>
                            <option value="Listrik">Listrik</option>
                            <option value="Air">Air</option>
                            <option value="Gaji">Gaji</option>
                            <option value="Lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Keterangan</label>
                        <input type="text" class="form-control" id="expense-description" placeholder="Keterangan pengeluaran">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jumlah (Rp)</label>
                        <input type="number" class="form-control" id="expense-amount" placeholder="Jumlah pengeluaran">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tanggal</label>
                        <input type="date" class="form-control" id="expense-date">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-expense-btn">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Refill Water Modal -->
    <div class="modal fade" id="refillModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Isi Ulang Air Tangki</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Jumlah Liter</label>
                        <input type="number" class="form-control" id="refill-amount" placeholder="Jumlah liter yang akan diisi">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tanggal</label>
                        <input type="date" class="form-control" id="refill-date">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Keterangan</label>
                        <textarea class="form-control" rows="2" id="refill-description" placeholder="Keterangan tambahan"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-refill-btn">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Setting Modal -->
    <div class="modal fade" id="editSettingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Pengaturan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" id="edit-setting-label">Nama Pengaturan</label>
                        <input type="text" class="form-control" id="edit-setting-value">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-setting-btn">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Receipt Modal -->
    <div class="modal fade" id="receiptModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nota Transaksi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="receipt-container" id="receipt-container">
                        <!-- Receipt will be generated dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-primary" id="print-receipt-btn">Cetak</button>
                    <button type="button" class="receipt-download-btn" id="download-receipt-btn">
                        <i class="bi bi-download"></i> Download Gambar
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Maps Modal -->
    <div class="modal fade" id="mapsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Lokasi Pelanggan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body maps-modal-body">
                    <div class="maps-container" id="maps-container">
                        <!-- Maps will be loaded dynamically as iframe -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Payment Modal - Diperbaiki, menghapus input keterangan -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pembayaran Hutang</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="payment-transaction-id">
                    <div class="mb-3">
                        <label class="form-label">Pelanggan</label>
                        <input type="text" class="form-control" id="payment-customer-name" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Total Hutang</label>
                        <input type="text" class="form-control" id="payment-total-debt" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Jumlah Bayar (Rp)</label>
                        <input type="number" class="form-control" id="payment-amount" placeholder="Masukkan jumlah pembayaran">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tanggal Pembayaran</label>
                        <input type="date" class="form-control" id="payment-date">
                    </div>
                    <!-- Input keterangan dihapus sesuai permintaan -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-payment-btn">Bayar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Toast Container -->
    <div class="toast-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // API Configuration
        const API_KEY = "AKfycby_6VvnaHFQ4hmJALaX5-Zk1bF-nHzyuGR_FfdDvtJfbu_YMWLsVycoCrtCT-DlyMAv";
        const API_URL = `https://script.google.com/macros/s/${API_KEY}/exec`;
        const SPREADSHEET_ID = "1-IA568-QQWdBL1Xv7FuFkl6PqpdHwLOQWSVsRmadweQ";
        
        // App State
        let appData = {
            transactions: [],
            products: [],
            waterStock: {},
            customers: [],
            expenses: [],
            settings: {},
            notifications: [],
            cart: [],
            selectedPaymentMethod: 'Lunas',
            dailySales: {}, // To store daily sales data for chart
            selectedCustomer: null,
            selectedProducts: {}, // Track selected products with quantities
            processing: false, // Track if any process is running
            menuSettings: {
                'dashboard-tab': { visible: true, position: 'bottom' },
                'transaksi-tab': { visible: true, position: 'bottom' },
                'riwayat-tab': { visible: true, position: 'bottom' },
                'produk-tab': { visible: true, position: 'bottom' },
                'pelanggan-tab': { visible: true, position: 'bottom' },
                'stok-tab': { visible: true, position: 'bottom' },
                'pengeluaran-tab': { visible: true, position: 'bottom' },
                'pengaturan-tab': { visible: true, position: 'bottom' }
            },
            productView: 'list', // Track current product view (list or grid)
            activeTab: 'transaction-history-tab' // Track active tab in riwayat section
        };
        
        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data
            loadSettings();
            loadProducts();
            loadCustomers();
            loadTransactions();
            loadWaterStock();
            loadExpenses();
            loadNotifications();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize UI
            updateDashboardStats();
            updateFinancialSummary();
            updateSalesChart();
            updateWaterLevel();
            updateTransactionDate();
            updateTopProducts();
            updateActiveCustomers();
            updateMonthlyExpense();
            
            // Initialize stock chart
            // initializeStockChart(); // Removed as requested
            
            // Calculate daily sales for chart
            calculateDailySales();
            
            // Set up FAB button based on active tab
            updateFabButton();
            
            // Initialize menu settings
            initializeMenuSettings();
            
            // Initialize product view toggle
            initializeProductViewToggle();
            
            // Initialize tab navigation in riwayat section
            initializeTabNavigation();
            
            // Hide search box initially
            document.getElementById('search-container').style.display = 'none';
            
            // Setup reset and backup buttons
            setupResetBackupButtons();
        });
        
        // Setup Event Listeners
        function setupEventListeners() {
            // Tab Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all tabs and contents
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show corresponding content
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // Auto refresh based on active tab
                    refreshTabData(tabId);
                    
                    // Update FAB button based on active tab
                    updateFabButton();
                    
                    // Update search box visibility based on active tab
                    updateSearchBoxVisibility(tabId);
                    
                    // Update banner based on active tab
                    updateBannerContent(tabId);
                });
            });
            
            // Product view toggle
            document.getElementById('list-view-btn').addEventListener('click', function() {
                setProductView('list');
            });
            
            document.getElementById('grid-view-btn').addEventListener('click', function() {
                setProductView('grid');
            });
            
            // Save Transaction Button
            document.getElementById('save-transaction-modal-btn').addEventListener('click', saveTransactionFromModal);
            
            // Save Product Button
            document.getElementById('save-product-btn').addEventListener('click', saveProduct);
            
            // Save Customer Button
            document.getElementById('save-customer-btn').addEventListener('click', saveCustomer);
            
            // Save Customer Name Button
            document.getElementById('save-customer-name-btn').addEventListener('click', saveCustomerName);
            
            // Delete Customer Button
            document.getElementById('delete-customer-btn').addEventListener('click', deleteCustomer);
            
            // Save Expense Button
            document.getElementById('save-expense-btn').addEventListener('click', saveExpense);
            
            // Save Refill Button
            document.getElementById('save-refill-btn').addEventListener('click', saveRefill);
            
            // Save Setting Button
            document.getElementById('save-setting-btn').addEventListener('click', saveSetting);
            
            // Print Receipt Button
            document.getElementById('print-receipt-btn').addEventListener('click', printReceipt);
            
            // Download Receipt Button
            document.getElementById('download-receipt-btn').addEventListener('click', downloadReceiptAsImage);
            
            // Search Input
            document.getElementById('search-input').addEventListener('input', handleSearch);
            
            // System Notification Toggle
            document.getElementById('system-notification-toggle').addEventListener('change', function() {
                updateSetting('Notifikasi', this.checked ? 'enable' : 'disable');
            });
            
            // Cashier functionality
            document.getElementById('clear-cart-btn').addEventListener('click', clearCart);
            document.getElementById('checkout-btn').addEventListener('click', checkout);
            
            // Payment method selection
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    appData.selectedPaymentMethod = this.getAttribute('data-payment');
                    
                    // Show/hide manual payment field
                    const manualPaymentContainer = document.getElementById('manual-payment-container');
                    if (appData.selectedPaymentMethod === 'Manual') {
                        manualPaymentContainer.style.display = 'block';
                    } else {
                        manualPaymentContainer.style.display = 'none';
                    }
                    
                    // Show/hide due date field
                    const dueDateContainer = document.getElementById('due-date-container');
                    if (appData.selectedPaymentMethod === 'Hutang') {
                        dueDateContainer.style.display = 'block';
                    } else {
                        dueDateContainer.style.display = 'none';
                    }
                });
            });
            
            // Settings edit buttons
            document.querySelectorAll('.settings-edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const field = this.getAttribute('data-field');
                    const value = this.getAttribute('data-value');
                    
                    document.getElementById('edit-setting-label').textContent = field;
                    document.getElementById('edit-setting-value').value = value;
                    
                    const modal = new bootstrap.Modal(document.getElementById('editSettingModal'));
                    modal.show();
                });
            });
            
            // Menu settings toggles
            document.querySelectorAll('.menu-toggle').forEach(toggle => {
                toggle.addEventListener('change', function() {
                    const menuId = this.getAttribute('data-menu');
                    const isVisible = this.checked;
                    
                    // Update menu settings
                    appData.menuSettings[menuId].visible = isVisible;
                    
                    // Apply menu visibility
                    updateMenuVisibility();
                    
                    // Save menu settings to local storage
                    saveMenuSettings();
                });
            });
            
            // Menu position selectors
            document.querySelectorAll('.menu-position-option').forEach(option => {
                option.addEventListener('click', function() {
                    const menuSettingsItem = this.closest('.menu-settings-item');
                    const menuToggle = menuSettingsItem.querySelector('.menu-toggle');
                    const menuId = menuToggle.getAttribute('data-menu');
                    const position = this.getAttribute('data-position');
                    
                    // Update active position option
                    const positionSelector = this.closest('.menu-position-selector');
                    positionSelector.querySelectorAll('.menu-position-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Update menu settings
                    appData.menuSettings[menuId].position = position;
                    
                    // Apply menu position
                    updateMenuPosition();
                    
                    // Save menu settings to local storage
                    saveMenuSettings();
                });
            });
            
            // Notification bell click
            document.getElementById('notification-bell').addEventListener('click', function(e) {
                e.stopPropagation();
                const dropdown = document.getElementById('notification-dropdown');
                dropdown.classList.toggle('show');
                
                // Close cart dropdown if open
                document.getElementById('cart-dropdown').classList.remove('show');
            });
            
            // Cart icon click
            document.getElementById('cart-icon').addEventListener('click', function(e) {
                e.stopPropagation();
                const dropdown = document.getElementById('cart-dropdown');
                dropdown.classList.toggle('show');
                
                // Close notification dropdown if open
                document.getElementById('notification-dropdown').classList.remove('show');
            });
            
            // Settings icon click
            document.getElementById('settings-icon').addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Switch to settings tab
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                const settingsTab = document.querySelector('.nav-item[data-tab="pengaturan-tab"]');
                const settingsContent = document.getElementById('pengaturan-tab');
                
                settingsTab.classList.add('active');
                settingsContent.classList.add('active');
                
                // Update FAB button
                updateFabButton();
                
                // Update search box visibility
                updateSearchBoxVisibility('pengaturan-tab');
            });
            
            // Clear notifications
            document.getElementById('clear-notifications').addEventListener('click', function() {
                // Mark all notifications as read
                appData.notifications.forEach(notification => {
                    if (notification['Status'] === 'enable') {
                        notification['Status'] = 'disable';
                        updateNotificationStatus(notification['Tanggal'], 'disable');
                    }
                });
                
                // Update UI
                updateNotificationsUI();
                updateNotificationBadge();
                updateNotificationDropdown();
                
                // Close dropdown
                document.getElementById('notification-dropdown').classList.remove('show');
            });
            
            // Clear cart
            document.getElementById('clear-cart').addEventListener('click', function() {
                clearCart();
                updateCartDropdown();
            });
            
            // Cart checkout button
            document.getElementById('cart-checkout-btn').addEventListener('click', function() {
                // Switch to transaction tab
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                const transactionTab = document.querySelector('.nav-item[data-tab="transaksi-tab"]');
                const transactionContent = document.getElementById('transaksi-tab');
                
                transactionTab.classList.add('active');
                transactionContent.classList.add('active');
                
                // Close dropdown
                document.getElementById('cart-dropdown').classList.remove('show');
                
                // Update FAB button
                updateFabButton();
                
                // Update search box visibility
                updateSearchBoxVisibility('transaksi-tab');
            });
            
            // Customer search input
            document.getElementById('cashier-customer-input').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                if (searchTerm.length > 0) {
                    // Filter customers based on search term
                    const filteredCustomers = appData.customers.filter(customer => 
                        customer['Nama'].toLowerCase().includes(searchTerm)
                    );
                    
                    // Show search results
                    displayCustomerSearchResults(filteredCustomers, searchTerm);
                } else {
                    // Hide search results
                    document.getElementById('customer-search-results').classList.remove('show');
                }
            });
            
            // FAB button click
            document.getElementById('fab-button').addEventListener('click', function() {
                const activeTab = document.querySelector('.nav-item.active').getAttribute('data-tab');
                
                switch(activeTab) {
                    case 'dashboard-tab':
                        // Tampilkan animasi refresh
                        showRefreshAnimation();
                        
                        // Refresh data
                        loadSettings();
                        loadProducts();
                        loadCustomers();
                        loadTransactions();
                        loadWaterStock();
                        loadExpenses();
                        loadNotifications();
                        updateDashboardStats();
                        updateFinancialSummary();
                        updateSalesChart();
                        updateWaterLevel();
                        updateTransactionDate();
                        updateTopProducts();
                        updateActiveCustomers();
                        updateMonthlyExpense();
                        // Hapus notifikasi "Data berhasil diperbarui"
                        break;
                        
                    case 'produk-tab':
                        // Open add product modal
                        const productModal = new bootstrap.Modal(document.getElementById('addProductModal'));
                        productModal.show();
                        break;
                        
                    case 'pelanggan-tab':
                        // Open add customer modal
                        const customerModal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
                        customerModal.show();
                        break;
                        
                    case 'stok-tab':
                        // Open refill modal if enabled, otherwise show message
                        if (!document.getElementById('refill-water-btn').disabled) {
                            const refillModal = new bootstrap.Modal(document.getElementById('refillModal'));
                            refillModal.show();
                        } else {
                            showToast('Stok air masih mencukupi', 'warning');
                        }
                        break;
                        
                    case 'pengeluaran-tab':
                        // Open add expense modal
                        const expenseModal = new bootstrap.Modal(document.getElementById('addExpenseModal'));
                        expenseModal.show();
                        break;
                        
                    case 'pengaturan-tab':
                        // Tampilkan animasi refresh
                        showRefreshAnimation();
                        
                        // Refresh settings
                        loadSettings();
                        // Hapus notifikasi "Pengaturan berhasil diperbarui"
                        break;
                        
                    case 'riwayat-tab':
                        // Tampilkan animasi refresh
                        showRefreshAnimation();
                        
                        // Refresh transaction history
                        loadTransactions();
                        updateTransactionHistoryUI();
                        updateDebtUI();
                        // Hapus notifikasi "Riwayat transaksi berhasil diperbarui"
                        break;
                }
            });
            
            // Checkout products button
            document.getElementById('checkout-products-btn').addEventListener('click', function() {
                // Switch to transaction tab
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                const transactionTab = document.querySelector('.nav-item[data-tab="transaksi-tab"]');
                const transactionContent = document.getElementById('transaksi-tab');
                
                transactionTab.classList.add('active');
                transactionContent.classList.add('active');
                
                // Update FAB button
                updateFabButton();
                
                // Update search box visibility
                updateSearchBoxVisibility('transaksi-tab');
            });
            
            // Payment button
            document.getElementById('save-payment-btn').addEventListener('click', savePayment);
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function() {
                document.getElementById('notification-dropdown').classList.remove('show');
                document.getElementById('cart-dropdown').classList.remove('show');
                document.getElementById('customer-search-results').classList.remove('show');
            });
        }
        
        // Setup Reset and Backup Buttons
        function setupResetBackupButtons() {
            // Reset Data Button
            document.getElementById('reset-data-btn').addEventListener('click', function() {
                if (confirm('Apakah Anda yakin ingin mereset semua data? Tindakan ini tidak dapat dibatalkan.')) {
                    resetAllData();
                }
            });
            
            // Backup Settings Button
            document.getElementById('backup-settings-btn').addEventListener('click', function() {
                backupSettings();
            });
            
            // Import Backup Input
            document.getElementById('import-backup-input').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    importBackup(file);
                }
            });
        }
        
        // Initialize Product View Toggle
        function initializeProductViewToggle() {
            // Set initial view based on appData.productView
            setProductView(appData.productView);
        }
        
        // Set Product View
        function setProductView(view) {
            appData.productView = view;
            
            // Update toggle buttons
            document.getElementById('list-view-btn').classList.toggle('active', view === 'list');
            document.getElementById('grid-view-btn').classList.toggle('active', view === 'grid');
            
            // Update view containers
            document.getElementById('product-list-container').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('product-grid-container').style.display = view === 'grid' ? 'grid' : 'none';
            
            // Update product display based on current view
            if (view === 'list') {
                updateProductsListView();
            } else {
                updateProductsGridView();
            }
        }
        
        // Initialize Menu Settings
        function initializeMenuSettings() {
            // Try to load menu settings from local storage
            const savedMenuSettings = localStorage.getItem('menuSettings');
            
            if (savedMenuSettings) {
                try {
                    appData.menuSettings = JSON.parse(savedMenuSettings);
                } catch (e) {
                    console.error('Error parsing menu settings from local storage:', e);
                    // Load from spreadsheet as fallback
                    loadMenuSettingsFromSpreadsheet();
                }
            } else {
                // Load from spreadsheet
                loadMenuSettingsFromSpreadsheet();
            }
            
            // Apply menu settings
            updateMenuVisibility();
            updateMenuPosition();
            
            // Update UI toggles and position selectors
            document.querySelectorAll('.menu-toggle').forEach(toggle => {
                const menuId = toggle.getAttribute('data-menu');
                toggle.checked = appData.menuSettings[menuId].visible;
            });
            
            document.querySelectorAll('.menu-settings-item').forEach(item => {
                const menuToggle = item.querySelector('.menu-toggle');
                const menuId = menuToggle.getAttribute('data-menu');
                const position = appData.menuSettings[menuId].position;
                
                const positionSelector = item.querySelector('.menu-position-selector');
                positionSelector.querySelectorAll('.menu-position-option').forEach(opt => {
                    opt.classList.remove('active');
                    if (opt.getAttribute('data-position') === position) {
                        opt.classList.add('active');
                    }
                });
            });
        }
        
        // Save Menu Settings to Local Storage
        function saveMenuSettings() {
            localStorage.setItem('menuSettings', JSON.stringify(appData.menuSettings));
            
            // Simpan juga ke spreadsheet
            const menuAtas = Object.keys(appData.menuSettings)
                .filter(key => appData.menuSettings[key].position === 'header' && appData.menuSettings[key].visible)
                .map(key => key.replace('-tab', ''))
                .join(',');
            
            const menuBawah = Object.keys(appData.menuSettings)
                .filter(key => appData.menuSettings[key].position === 'bottom' && appData.menuSettings[key].visible)
                .map(key => key.replace('-tab', ''))
                .join(',');
            
            // Update settings in spreadsheet
            updateData('Pengaturan', 2, { 
                'Menu Atas': menuAtas, 
                'Menu Bawah': menuBawah 
            });
        }
        
        // Load Menu Settings from Spreadsheet
        async function loadMenuSettingsFromSpreadsheet() {
            try {
                const settings = await fetchData('Pengaturan');
                if (settings && settings[0]) {
                    const menuAtas = settings[0]['Menu Atas'] || '';
                    const menuBawah = settings[0]['Menu Bawah'] || '';
                    
                    // Parse menu atas
                    if (menuAtas) {
                        const atasItems = menuAtas.split(',');
                        atasItems.forEach(item => {
                            const tabId = item.trim() + '-tab';
                            if (appData.menuSettings[tabId]) {
                                appData.menuSettings[tabId].position = 'header';
                                appData.menuSettings[tabId].visible = true;
                            }
                        });
                    }
                    
                    // Parse menu bawah
                    if (menuBawah) {
                        const bawahItems = menuBawah.split(',');
                        bawahItems.forEach(item => {
                            const tabId = item.trim() + '-tab';
                            if (appData.menuSettings[tabId]) {
                                appData.menuSettings[tabId].position = 'bottom';
                                appData.menuSettings[tabId].visible = true;
                            }
                        });
                    }
                    
                    // Update UI
                    updateMenuVisibility();
                    updateMenuPosition();
                    
                    // Save to localStorage
                    localStorage.setItem('menuSettings', JSON.stringify(appData.menuSettings));
                }
            } catch (error) {
                console.error('Error loading menu settings from spreadsheet:', error);
            }
        }
        
        // Update Menu Visibility
        function updateMenuVisibility() {
            // Update bottom navigation visibility
            document.querySelectorAll('.nav-item').forEach(item => {
                const tabId = item.getAttribute('data-tab');
                if (appData.menuSettings[tabId].visible) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // Update Menu Position
        function updateMenuPosition() {
            // Create header navigation if it doesn't exist
            let headerNav = document.getElementById('header-nav');
            if (!headerNav) {
                headerNav = document.createElement('div');
                headerNav.id = 'header-nav';
                headerNav.className = 'header-nav';
                headerNav.style.display = 'flex';
                headerNav.style.gap = '15px';
                headerNav.style.marginLeft = 'auto';
                
                // Insert before header actions
                const headerActions = document.querySelector('.header-actions');
                headerActions.parentNode.insertBefore(headerNav, headerActions);
            }
            
            // Clear header navigation
            headerNav.innerHTML = '';
            
            // Move menu items to header or bottom based on settings
            const bottomNav = document.getElementById('bottom-nav');
            
            // Get all nav items
            const navItems = Array.from(document.querySelectorAll('.nav-item'));
            
            // Sort nav items by original order
            navItems.sort((a, b) => {
                const order = ['dashboard-tab', 'transaksi-tab', 'riwayat-tab', 'produk-tab', 'pelanggan-tab', 'stok-tab', 'pengeluaran-tab', 'pengaturan-tab'];
                return order.indexOf(a.getAttribute('data-tab')) - order.indexOf(b.getAttribute('data-tab'));
            });
            
            // Process each nav item
            navItems.forEach(item => {
                const tabId = item.getAttribute('data-tab');
                const position = appData.menuSettings[tabId].position;
                
                if (position === 'header' && appData.menuSettings[tabId].visible) {
                    // Clone the item for header navigation
                    const headerItem = item.cloneNode(true);
                    headerItem.classList.remove('nav-item');
                    headerItem.classList.add('header-nav-item');
                    headerItem.style.color = 'var(--white)';
                    headerItem.style.textDecoration = 'none';
                    headerItem.style.display = 'flex';
                    headerItem.style.flexDirection = 'column';
                    headerItem.style.alignItems = 'center';
                    headerItem.style.fontSize = '12px';
                    
                    // Only show icon in header navigation (no text)
                    const icon = headerItem.querySelector('.nav-icon');
                    const label = headerItem.querySelector('.nav-label');
                    if (label) {
                        label.style.display = 'none';
                    }
                    
                    // Add event listener to header item
                    headerItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        // Trigger click on original item
                        item.click();
                    });
                    
                    // Add to header navigation
                    headerNav.appendChild(headerItem);
                }
            });
            
            // Update bottom nav items visibility
            navItems.forEach(item => {
                const tabId = item.getAttribute('data-tab');
                const position = appData.menuSettings[tabId].position;
                
                if (position === 'header' && appData.menuSettings[tabId].visible) {
                    item.style.display = 'none';
                } else if (appData.menuSettings[tabId].visible) {
                    item.style.display = 'flex';
                }
            });
            
            // Update active state in header nav
            const activeTab = document.querySelector('.nav-item.active');
            if (activeTab) {
                const activeTabId = activeTab.getAttribute('data-tab');
                const activeHeaderItem = headerNav.querySelector(`[data-tab="${activeTabId}"]`);
                if (activeHeaderItem) {
                    // Add active class to header item
                    activeHeaderItem.style.color = 'var(--white)';
                    activeHeaderItem.style.fontWeight = 'bold';
                }
            }
        }
        
        // Update FAB Button based on active tab
        function updateFabButton() {
            const activeTab = document.querySelector('.nav-item.active').getAttribute('data-tab');
            const fabButton = document.getElementById('fab-button');
            
            // Remove all existing event listeners to avoid duplicates
            const newFabButton = fabButton.cloneNode(true);
            fabButton.parentNode.replaceChild(newFabButton, fabButton);
            
            // Update icon and functionality based on active tab
            switch(activeTab) {
                case 'dashboard-tab':
                case 'riwayat-tab':
                case 'pengaturan-tab':
                    newFabButton.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                    newFabButton.title = 'Refresh';
                    break;
                    
                case 'produk-tab':
                    newFabButton.innerHTML = '<i class="bi bi-plus-circle"></i>';
                    newFabButton.title = 'Tambah Produk';
                    break;
                    
                case 'pelanggan-tab':
                    newFabButton.innerHTML = '<i class="bi bi-person-plus"></i>';
                    newFabButton.title = 'Tambah Pelanggan';
                    break;
                    
                case 'stok-tab':
                    newFabButton.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
                    newFabButton.title = 'Isi Ulang Air';
                    break;
                    
                case 'pengeluaran-tab':
                    newFabButton.innerHTML = '<i class="bi bi-plus-circle"></i>';
                    newFabButton.title = 'Tambah Pengeluaran';
                    break;
                    
                default:
                    newFabButton.innerHTML = '<i class="bi bi-plus"></i>';
                    newFabButton.title = 'Tambah';
            }
            
            // Add event listener to the new button
            newFabButton.addEventListener('click', function() {
                const activeTab = document.querySelector('.nav-item.active').getAttribute('data-tab');
                
                switch(activeTab) {
                    case 'dashboard-tab':
                        // Tampilkan animasi refresh
                        showRefreshAnimation();
                        
                        // Refresh data
                        loadSettings();
                        loadProducts();
                        loadCustomers();
                        loadTransactions();
                        loadWaterStock();
                        loadExpenses();
                        loadNotifications();
                        updateDashboardStats();
                        updateFinancialSummary();
                        updateSalesChart();
                        updateWaterLevel();
                        updateTransactionDate();
                        updateTopProducts();
                        updateActiveCustomers();
                        updateMonthlyExpense();
                        // Hapus notifikasi "Data berhasil diperbarui"
                        break;
                        
                    case 'produk-tab':
                        // Open add product modal
                        const productModal = new bootstrap.Modal(document.getElementById('addProductModal'));
                        productModal.show();
                        break;
                        
                    case 'pelanggan-tab':
                        // Open add customer modal
                        const customerModal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
                        customerModal.show();
                        break;
                        
                    case 'stok-tab':
                        // Open refill modal if enabled, otherwise show message
                        if (!document.getElementById('refill-water-btn').disabled) {
                            const refillModal = new bootstrap.Modal(document.getElementById('refillModal'));
                            refillModal.show();
                        } else {
                            showToast('Stok air masih mencukupi', 'warning');
                        }
                        break;
                        
                    case 'pengeluaran-tab':
                        // Open add expense modal
                        const expenseModal = new bootstrap.Modal(document.getElementById('addExpenseModal'));
                        expenseModal.show();
                        break;
                        
                    case 'pengaturan-tab':
                        // Tampilkan animasi refresh
                        showRefreshAnimation();
                        
                        // Refresh settings
                        loadSettings();
                        // Hapus notifikasi "Pengaturan berhasil diperbarui"
                        break;
                        
                    case 'riwayat-tab':
                        // Tampilkan animasi refresh
                        showRefreshAnimation();
                        
                        // Refresh transaction history
                        loadTransactions();
                        updateTransactionHistoryUI();
                        updateDebtUI();
                        // Hapus notifikasi "Riwayat transaksi berhasil diperbarui"
                        break;
                }
            });
        }
        
        // Initialize Tab Navigation in Riwayat Section
        function initializeTabNavigation() {
            // Add event listeners to tab navigation items
            document.querySelectorAll('.tab-navigation-item').forEach(item => {
                item.addEventListener('click', function() {
                    // Remove active class from all tab navigation items
                    document.querySelectorAll('.tab-navigation-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Hide all tab content containers
                    document.querySelectorAll('.tab-content-container').forEach(container => {
                        container.classList.remove('active');
                    });
                    
                    // Show the selected tab content
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // Update active tab in app data
                    appData.activeTab = tabId;
                    
                    // Refresh data based on selected tab
                    if (tabId === 'debt-tab') {
                        updateDebtUI();
                    }
                });
            });
        }
        
        // Update search box visibility based on active tab
        function updateSearchBoxVisibility(tabId) {
            const searchContainer = document.getElementById('search-container');
            
            // Only show search box for riwayat, produk, and pelanggan tabs
            if (tabId === 'riwayat-tab' || tabId === 'produk-tab' || tabId === 'pelanggan-tab') {
                searchContainer.style.display = 'block';
            } else {
                searchContainer.style.display = 'none';
            }
        }
        
        // Update banner content based on active tab
        function updateBannerContent(tabId) {
            const bannerContainer = document.getElementById('banner-container');
            const bannerTitle = document.getElementById('monthly-revenue');
            const bannerSubtitle = document.querySelector('.banner-subtitle');
            
            // Hide banner for transaksi tab
            if (tabId === 'transaksi-tab') {
                bannerContainer.style.display = 'none';
                return;
            } else {
                bannerContainer.style.display = 'block';
            }
            
            // Update banner content based on active tab
            switch(tabId) {
                case 'riwayat-tab':
                    // Count lunas and hutang transactions
                    const lunasCount = appData.transactions.filter(t => t['Status'] === 'Lunas').length;
                    const hutangCount = appData.transactions.filter(t => t['Status'] === 'Hutang').length;
                    
                    bannerTitle.textContent = `${lunasCount} Lunas / ${hutangCount} Hutang`;
                    bannerSubtitle.textContent = 'Total Transaksi';
                    break;
                    
                case 'produk-tab':
                    // Show product count
                    bannerTitle.textContent = `${appData.products.length} Produk`;
                    bannerSubtitle.textContent = 'Total Produk Tersedia';
                    break;
                    
                case 'pelanggan-tab':
                    // Show customer count
                    bannerTitle.textContent = `${appData.customers.length} Pelanggan`;
                    bannerSubtitle.textContent = 'Total Pelanggan Terdaftar';
                    break;
                    
                case 'stok-tab':
                    // Show remaining water stock
                    const waterStock = appData.waterStock;
                    const remainingWater = parseInt(waterStock['Sisa Liter'] || 0);
                    bannerTitle.textContent = `${remainingWater} Liter`;
                    bannerSubtitle.textContent = 'Sisa Stok Air Tersedia';
                    break;
                    
                default:
                    // Default to monthly revenue
                    bannerTitle.textContent = 'Rp. 0';
                    bannerSubtitle.textContent = 'Omset Pemasukan Bulan Ini';
            }
        }
        
        // Display customer search results
        function displayCustomerSearchResults(customers, searchTerm) {
            const resultsContainer = document.getElementById('customer-search-results');
            resultsContainer.innerHTML = '';
            
            if (customers.length === 0) {
                // Show option to add new customer
                const addNewOption = document.createElement('div');
                addNewOption.className = 'customer-search-item';
                addNewOption.innerHTML = `<i class="bi bi-person-plus"></i> Tambah pelanggan baru: "${searchTerm}"`;
                addNewOption.addEventListener('click', function() {
                    // Set the input value to the new customer name
                    document.getElementById('cashier-customer-input').value = searchTerm;
                    
                    // Create a new customer object
                    const newCustomer = {
                        'ID Pelanggan': generateCustomerId(),
                        'Nama': searchTerm,
                        'Kontak': '',
                        'Alamat': '',
                        'Galon Titipan': 0,
                        'Maps': ''
                    };
                    
                    // Set as selected customer
                    appData.selectedCustomer = newCustomer;
                    
                    // Hide search results
                    resultsContainer.classList.remove('show');
                });
                
                resultsContainer.appendChild(addNewOption);
            } else {
                // Show matching customers
                customers.forEach(customer => {
                    const customerOption = document.createElement('div');
                    customerOption.className = 'customer-search-item';
                    customerOption.innerHTML = `
                        <div>${customer['Nama']}</div>
                        <small>${customer['Kontak'] || 'No contact'}</small>
                    `;
                    
                    customerOption.addEventListener('click', function() {
                        // Set the input value to the selected customer name
                        document.getElementById('cashier-customer-input').value = customer['Nama'];
                        
                        // Set as selected customer
                        appData.selectedCustomer = customer;
                        
                        // Hide search results
                        resultsContainer.classList.remove('show');
                    });
                    
                    resultsContainer.appendChild(customerOption);
                });
            }
            
            // Show results container
            resultsContainer.classList.add('show');
        }
        
        // Generate random customer ID
        function generateCustomerId() {
            const timestamp = Date.now();
            return `CUST-${timestamp}`;
        }
        
        // API Functions
        async function fetchData(sheet, action = 'get-data', params = {}) {
            try {
                // Check if API key is set
                if (!API_KEY || API_KEY === '') {
                    showToast('API Key tidak valid. Silakan periksa pengaturan.', 'danger');
                    return null;
                }
                
                const url = new URL(API_URL);
                url.searchParams.append('sheet', sheet);
                url.searchParams.append('action', action);
                
                // Add additional parameters
                Object.keys(params).forEach(key => {
                    url.searchParams.append(key, params[key]);
                });
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    return data.data;
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showToast('Error: ' + error.message, 'danger');
                return null;
            }
        }
        
        async function insertData(sheet, data) {
            try {
                // Check if API key is set
                if (!API_KEY || API_KEY === '') {
                    showToast('API Key tidak valid. Silakan periksa pengaturan.', 'danger');
                    return false;
                }
                
                const url = new URL(API_URL);
                url.searchParams.append('sheet', sheet);
                url.searchParams.append('action', 'insert');
                
                // Add data parameters
                Object.keys(data).forEach(key => {
                    url.searchParams.append(key, data[key]);
                });
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    // Menghapus notifikasi "Data berhasil disimpan" sesuai permintaan
                    return true;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error inserting data:', error);
                showToast('Error: ' + error.message, 'danger');
                return false;
            }
        }
        
        async function updateData(sheet, row, data) {
            try {
                // Check if API key is set
                if (!API_KEY || API_KEY === '') {
                    showToast('API Key tidak valid. Silakan periksa pengaturan.', 'danger');
                    return false;
                }
                
                const url = new URL(API_URL);
                url.searchParams.append('sheet', sheet);
                url.searchParams.append('action', 'update');
                url.searchParams.append('row', row);
                
                // Add data parameters
                Object.keys(data).forEach(key => {
                    url.searchParams.append(key, data[key]);
                });
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    // Menghapus notifikasi "Data berhasil diperbarui" sesuai permintaan
                    return true;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error updating data:', error);
                showToast('Error: ' + error.message, 'danger');
                return false;
            }
        }
        
        async function updateNotificationStatus(date, status) {
            try {
                // Find the notification in the app data
                const notification = appData.notifications.find(n => n['Tanggal'] === date);
                
                if (notification) {
                    // Get the row number (assuming notifications are in order)
                    const index = appData.notifications.indexOf(notification) + 2; // +2 for header and 1-based index
                    
                    // Update the notification
                    const success = await updateData('Notifikasi', index, { 'Status': status });
                    
                    if (success) {
                        // Update the notification in app data
                        notification['Status'] = status;
                        return true;
                    }
                }
                
                return false;
            } catch (error) {
                console.error('Error updating notification status:', error);
                return false;
            }
        }
        
        // Load Data Functions
        async function loadSettings() {
            const settings = await fetchData('Pengaturan');
            if (settings) {
                appData.settings = settings[0] || {};
                updateSettingsUI();
                updateWaterLevelThreshold();
                updateSettingsBanner();
                
                // Load menu settings from localStorage
                const savedMenuSettings = localStorage.getItem('menuSettings');
                if (savedMenuSettings) {
                    try {
                        appData.menuSettings = JSON.parse(savedMenuSettings);
                        updateMenuVisibility();
                        updateMenuPosition();
                    } catch (e) {
                        console.error('Error parsing menu settings from local storage:', e);
                    }
                }
            }
        }
        
        async function loadProducts() {
            const products = await fetchData('Produk');
            if (products) {
                appData.products = products;
                updateProductsUI();
                populateProductSelects();
                populateCashierProductGrid();
            }
        }
        
        async function loadCustomers() {
            const customers = await fetchData('Pelanggan');
            if (customers) {
                appData.customers = customers;
                updateCustomersUI();
                populateCustomerSelects();
            }
        }
        
        async function loadTransactions() {
            const transactions = await fetchData('Transaksi');
            if (transactions) {
                appData.transactions = transactions;
                updateTransactionsUI();
                updateTransactionHistoryUI();
                updateDebtUI();
                calculateDailySales();
                
                // Perbaiki ketidaksesuaian data hutang
                await fixDebtInconsistencies();
            }
        }
        
        async function loadWaterStock() {
            const waterStock = await fetchData('Stok Air');
            if (waterStock) {
                appData.waterStock = waterStock[0] || {};
                updateWaterStockUI();
                updateStockHistory();
                updateWaterLevelThreshold();
            }
        }
        
        async function loadExpenses() {
            const expenses = await fetchData('Pengeluaran');
            if (expenses) {
                appData.expenses = expenses;
                updateExpensesUI();
                updateMonthlyExpense();
            }
        }
        
        async function loadNotifications() {
            const notifications = await fetchData('Notifikasi');
            if (notifications) {
                appData.notifications = notifications;
                updateNotificationsUI();
                updateNotificationBadge();
                updateNotificationDropdown();
            }
        }
        
        // Update UI Functions
        function updateSettingsUI() {
            const settings = appData.settings;
            
            // Update business info
            document.getElementById('app-title').textContent = settings['Nama Usaha'] || 'YOUSHE';
            document.getElementById('business-name').textContent = settings['Nama Usaha'] || 'YOUSHE';
            document.getElementById('business-address').textContent = settings['Alamat Usaha'] || 'Jaten Karanganyar';
            document.getElementById('business-contact').textContent = settings['Kontak'] || '+6285867271777';
            
            // Update water settings
            document.getElementById('tank-capacity-setting').textContent = (settings['Kapasitas Toren (Liter)'] || '8000') + ' Liter';
            document.getElementById('water-supply-cost').textContent = 'Rp ' + (settings['Biaya Suplai Air Tangki (Rp)'] || '300000');
            
            // Update API key
            document.getElementById('api-key-setting').textContent = settings['API'] || API_KEY;
            
            // Update logo
            document.getElementById('business-logo').textContent = settings['Logo'] || 'https://forumu.github.io/gen/logo.png';
            
            // Update receipt footer
            const receiptFooter = settings['Footer Nota'] || 'Terima kasih atas kunjungan Anda';
            document.getElementById('receipt-footer-setting').textContent = receiptFooter;
            document.getElementById('receipt-footer-preview').textContent = receiptFooter;
            
            // Update edit button data attributes
            document.querySelectorAll('.settings-edit-btn').forEach(btn => {
                const field = btn.getAttribute('data-field');
                if (settings[field] !== undefined) {
                    btn.setAttribute('data-value', settings[field]);
                    const valueElement = btn.previousElementSibling;
                    if (field === 'Biaya Suplai Air Tangki (Rp)') {
                        valueElement.textContent = 'Rp ' + settings[field];
                    } else if (field === 'Kapasitas Toren (Liter)') {
                        valueElement.textContent = settings[field] + ' Liter';
                    } else {
                        valueElement.textContent = settings[field];
                    }
                }
            });
            
            // Update header logo and subtitle
            updateHeaderLogo();
            updateHeaderSubtitle();
            
            // Update water stock details when settings change
            updateWaterStockDetails();
        }
        
        // Update Settings Banner
        function updateSettingsBanner() {
            const settings = appData.settings;
            
            // Update banner logo
            const bannerLogo = document.getElementById('settings-banner-logo');
            if (bannerLogo) {
                bannerLogo.src = settings['Logo'] || 'https://forumu.github.io/gen/logo.png';
            }
            
            // Update banner title
            const bannerTitle = document.getElementById('settings-banner-title');
            if (bannerTitle) {
                bannerTitle.textContent = settings['Nama Usaha'] || 'YOUSHE';
            }
            
            // Update banner subtitle
            const bannerSubtitle = document.getElementById('settings-banner-subtitle');
            if (bannerSubtitle) {
                bannerSubtitle.textContent = 'Depot Air Minum Isi Ulang';
            }
            
            // Update banner address
            const bannerAddress = document.getElementById('settings-banner-address');
            if (bannerAddress) {
                bannerAddress.textContent = settings['Alamat Usaha'] || 'Jaten Karanganyar';
            }
        }
        
        // Fungsi untuk memperbarui logo header
        function updateHeaderLogo() {
            const headerLogo = document.getElementById('header-logo');
            const logoUrl = appData.settings['Logo'] || '';
            
            if (logoUrl) {
                // Jika ada URL logo, ganti icon dengan gambar
                headerLogo.innerHTML = `<img src="${logoUrl}" alt="Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            } else {
                // Jika tidak ada URL, gunakan icon default
                headerLogo.innerHTML = '<i class="bi bi-droplet-fill"></i>';
            }
        }
        
        // Fungsi untuk memperbarui subtitle (alamat usaha)
        function updateHeaderSubtitle() {
            const appSubtitle = document.getElementById('app-subtitle');
            const businessAddress = appData.settings['Alamat Usaha'] || 'Depot Air Minum Isi Ulang';
            
            appSubtitle.textContent = businessAddress;
        }
        
        function updateWaterStockDetails() {
            const settings = appData.settings;
            const waterStock = appData.waterStock;
            
            // Get values from settings
            const capacity = parseInt(settings['Kapasitas Toren (Liter)'] || 8000);
            const totalCost = parseInt(settings['Total Biaya Suplai (Rp)'] || 300000);
            const remaining = parseInt(waterStock['Sisa Liter'] || 0);
            const used = parseInt(waterStock['Liter Terpakai'] || 0);
            const totalUsed = parseInt(waterStock['Total Liter Terpakai'] || 0);
            
            // Calculate percentage
            const percentage = Math.round((remaining / capacity) * 100);
            
            // Update water level UI
            document.getElementById('water-level').style.height = `${percentage}%`;
            document.getElementById('water-percentage').textContent = `${percentage}%`;
            
            // Update water info
            document.getElementById('remaining-water').textContent = `${remaining} L`;
            document.getElementById('used-water').textContent = `${used} L`;
            document.getElementById('tank-capacity').textContent = `${capacity} L`;
            
            // Update water stock details
            document.getElementById('detail-remaining-water').textContent = `${remaining} L`;
            document.getElementById('detail-used-water').textContent = `${used} L`;
            document.getElementById('detail-total-used-water').textContent = `${totalUsed} L`;
            document.getElementById('detail-tank-capacity').textContent = `${capacity} L`;
            document.getElementById('detail-total-cost').textContent = `Rp ${totalCost.toLocaleString('id-ID')}`;
            
            // Update dashboard stats
            document.getElementById('water-stock').textContent = `${remaining} L`;
        }
        
        function updateProductsUI() {
            // Update based on current view
            if (appData.productView === 'list') {
                updateProductsListView();
            } else {
                updateProductsGridView();
            }
        }
        
        function updateProductsListView() {
            const container = document.getElementById('product-list-container');
            container.innerHTML = '';
            
            if (appData.products.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada produk</div>';
                return;
            }
            
            appData.products.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'product-list-item';
                productItem.setAttribute('data-id', product['ID Produk']);
                
                // Check if product is selected
                const isSelected = appData.selectedProducts[product['ID Produk']] || 0;
                
                // Add selected class if product is in cart
                if (isSelected > 0) {
                    productItem.classList.add('selected');
                }
                
                productItem.innerHTML = `
                    <div class="product-list-icon">
                        <i class="bi bi-droplet"></i>
                    </div>
                    <div class="product-list-info">
                        <div class="product-list-name">${product['Nama Produk'] || 'Unknown Product'}</div>
                        <div class="product-list-details">
                            <div class="product-list-stock">Stok: ${product['Liter'] || 0} L</div>
                            <div class="product-list-price">Rp ${parseInt(product['Harga Jual (Rp)'] || 0).toLocaleString('id-ID')}</div>
                        </div>
                    </div>
                    ${isSelected > 0 ? `<div class="product-list-quantity">${isSelected}</div>` : ''}
                `;
                
                productItem.addEventListener('click', function() {
                    selectProduct(product);
                });
                
                container.appendChild(productItem);
            });
            
            // Show/hide checkout button based on selected products
            const hasSelectedProducts = Object.keys(appData.selectedProducts).length > 0;
            document.getElementById('checkout-products-btn').style.display = hasSelectedProducts ? 'block' : 'none';
        }
        
        function updateProductsGridView() {
            const container = document.getElementById('product-grid-container');
            container.innerHTML = '';
            
            if (appData.products.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada produk</div>';
                return;
            }
            
            appData.products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.setAttribute('data-id', product['ID Produk']);
                
                // Check if product is selected
                const isSelected = appData.selectedProducts[product['ID Produk']] || 0;
                
                productCard.innerHTML = `
                    <div class="product-image">
                        <i class="bi bi-droplet"></i>
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product['Nama Produk'] || 'Unknown Product'}</div>
                        <div class="product-price">Rp ${parseInt(product['Harga Jual (Rp)'] || 0).toLocaleString('id-ID')}</div>
                        <div class="product-stock">Stok: ${product['Liter'] || 0} L</div>
                    </div>
                    ${isSelected > 0 ? `<div class="product-quantity-badge">${isSelected}</div>` : ''}
                `;
                
                productCard.addEventListener('click', function() {
                    selectProduct(product);
                });
                
                container.appendChild(productCard);
            });
            
            // Show/hide checkout button based on selected products
            const hasSelectedProducts = Object.keys(appData.selectedProducts).length > 0;
            document.getElementById('checkout-products-btn').style.display = hasSelectedProducts ? 'block' : 'none';
        }
        
        // PERBAIKAN: Fungsi selectProduct yang diperbaiki
        function selectProduct(product) {
            const productId = product['ID Produk'];
            
            // Increment or add to selected products
            if (appData.selectedProducts[productId]) {
                appData.selectedProducts[productId]++;
            } else {
                appData.selectedProducts[productId] = 1;
            }
            
            // Update UI based on current view
            if (appData.productView === 'list') {
                updateProductsListView();
            } else {
                updateProductsGridView();
            }
            
            // Add to cart
            addToCart(product);
        }
        
        function populateCashierProductGrid() {
            const container = document.getElementById('cashier-product-grid');
            container.innerHTML = '';
            
            if (appData.products.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada produk</div>';
                return;
            }
            
            appData.products.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'product-item';
                productItem.setAttribute('data-id', product['ID Produk']);
                
                // Check if product is in cart
                const cartItem = appData.cart.find(item => item.id === product['ID Produk']);
                const quantity = cartItem ? cartItem.quantity : 0;
                
                productItem.innerHTML = `
                    <div class="product-icon">
                        <i class="bi bi-droplet"></i>
                    </div>
                    <div class="product-name">${product['Nama Produk'] || 'Unknown Product'}</div>
                    <div class="product-price">Rp ${parseInt(product['Harga Jual (Rp)'] || 0).toLocaleString('id-ID')}</div>
                    ${quantity > 0 ? `<div class="product-quantity-badge">${quantity}</div>` : ''}
                `;
                
                productItem.addEventListener('click', function() {
                    addToCart(product);
                });
                
                container.appendChild(productItem);
            });
        }
        
        function updateCustomersUI() {
            const container = document.getElementById('customers-container');
            container.innerHTML = '';
            
            if (appData.customers.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada pelanggan</div>';
                return;
            }
            
            // Sort customers by newest first (based on ID)
            const sortedCustomers = [...appData.customers].sort((a, b) => {
                // Extract timestamp from ID if it exists, otherwise use the whole ID
                const aTimestamp = a['ID Pelanggan'].includes('-') ? 
                    parseInt(a['ID Pelanggan'].split('-')[1]) : 
                    parseInt(a['ID Pelanggan']) || 0;
                const bTimestamp = b['ID Pelanggan'].includes('-') ? 
                    parseInt(b['ID Pelanggan'].split('-')[1]) : 
                    parseInt(b['ID Pelanggan']) || 0;
                return bTimestamp - aTimestamp; // Sort in descending order (newest first)
            });
            
            sortedCustomers.forEach(customer => {
                const customerItem = document.createElement('div');
                customerItem.className = 'customer-item';
                
                // Get initials for avatar
                const name = customer['Nama'] || 'Unknown';
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                // Format WhatsApp number
                let whatsappNumber = customer['Kontak'] || '';
                if (whatsappNumber) {
                    // Remove spaces and dashes
                    whatsappNumber = whatsappNumber.replace(/[\s-]/g, '');
                    // Replace leading 0 with +62
                    if (whatsappNumber.startsWith('0')) {
                        whatsappNumber = '+62' + whatsappNumber.substring(1);
                    }
                }
                
                customerItem.innerHTML = `
                    <div class="customer-avatar">${initials}</div>
                    <div class="customer-info">
                        <div class="customer-name" style="cursor: pointer;" data-id="${customer['ID Pelanggan']}" data-name="${name}" data-contact="${customer['Kontak'] || ''}" data-address="${customer['Alamat'] || ''}" data-deposit="${customer['Galon Titipan'] || 0}" data-maps="${customer['Maps'] || ''}">${name}</div>
                        <div class="customer-stats">${customer['Kontak'] || 'No contact'}</div>
                        <div class="customer-stats">${customer['Alamat'] || 'No address'}</div>
                        ${customer['Galon Titipan'] > 0 ? `<div class="customer-stats">Galon Titipan: ${customer['Galon Titipan']}</div>` : ''}
                        ${customer['Maps'] ? `<div class="customer-stats"><i class="bi bi-geo-alt"></i> Lokasi tersedia</div>` : ''}
                        </div>
                    <div class="customer-actions">
                        ${whatsappNumber ? `<a href="https://wa.me/${whatsappNumber.replace(/\+/g, '')}" target="_blank" class="customer-action whatsapp" title="WhatsApp">
                            <i class="bi bi-whatsapp"></i>
                        </a>` : ''}
                        ${customer['Maps'] ? `<a href="#" class="customer-action location" title="Lokasi" data-maps="${customer['Maps']}">
                            <i class="bi bi-geo-alt"></i>
                        </a>` : ''}
                    </div>
                `;
                container.appendChild(customerItem);
            });
            
            // Add event listeners to customer names
            document.querySelectorAll('.customer-name').forEach(nameElement => {
                nameElement.addEventListener('click', function() {
                    const customerId = this.getAttribute('data-id');
                    const customerName = this.getAttribute('data-name');
                    const customerContact = this.getAttribute('data-contact');
                    const customerAddress = this.getAttribute('data-address');
                    const customerDeposit = this.getAttribute('data-deposit');
                    const customerMaps = this.getAttribute('data-maps');
                    showEditCustomerModal(customerId, customerName, customerContact, customerAddress, customerDeposit, customerMaps);
                });
            });
            
            // Add event listeners to location buttons
            document.querySelectorAll('.customer-action.location').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const mapsUrl = this.getAttribute('data-maps');
                    showMapsModal(mapsUrl);
                });
            });
        }
        
        function showEditCustomerModal(customerId, customerName, customerContact, customerAddress, customerDeposit, customerMaps) {
            // Isi modal dengan data pelanggan
            document.getElementById('edit-customer-id').value = customerId;
            document.getElementById('edit-customer-name').value = customerName;
            document.getElementById('edit-customer-contact').value = customerContact;
            document.getElementById('edit-customer-address').value = customerAddress;
            document.getElementById('edit-customer-deposit').value = customerDeposit;
            document.getElementById('edit-customer-maps').value = customerMaps;
            
            // Tampilkan modal
            const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
            modal.show();
        }
        
        function showMapsModal(mapsUrl) {
            const mapsContainer = document.getElementById('maps-container');
            
            // Check if it's an embed URL or a regular Google Maps URL
            if (mapsUrl.includes('google.com/maps')) {
                // Convert to embed URL if it's not already
                let embedUrl = mapsUrl;
                if (!mapsUrl.includes('/embed')) {
                    // Extract the place ID from the URL
                    const match = mapsUrl.match(/!1s([^!]+)/);
                    if (match && match[1]) {
                        embedUrl = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d387190.2799160891!2d-122.42067955555556!3d37.7749295!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1`;
                    } else {
                        // Fallback to a simple embed
                        embedUrl = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d387190.2799160891!2d-122.42067955555556!3d37.7749295!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1`;
                    }
                }
                
                // Create iframe for maps
                mapsContainer.innerHTML = `<iframe src="${embedUrl}" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;
            } else {
                // If it's not a Google Maps URL, create a simple iframe with the URL
                mapsContainer.innerHTML = `<iframe src="${mapsUrl}" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>`;
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('mapsModal'));
            modal.show();
        }
        
        function updateTransactionsUI() {
            // Update recent transactions in dashboard
            const container = document.getElementById('recent-transactions-container');
            container.innerHTML = '';
            
            if (appData.transactions.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada transaksi</div>';
                return;
            }
            
            // Group transactions by ID Transaksi
            const groupedTransactions = {};
            appData.transactions.forEach(transaction => {
                const id = transaction['ID Transaksi'];
                if (!groupedTransactions[id]) {
                    groupedTransactions[id] = [];
                }
                groupedTransactions[id].push(transaction);
            });
            
            // Get the 3 most recent transactions
            const recentTransactions = Object.values(groupedTransactions)
                .sort((a, b) => new Date(b[0]['Tanggal']) - new Date(a[0]['Tanggal']))
                .slice(0, 3);
            
            recentTransactions.forEach(transactionGroup => {
                const transaction = transactionGroup[0];
                const transactionItem = document.createElement('div');
                transactionItem.className = 'transaction-item';
                
                const date = new Date(transaction['Tanggal']);
                const formattedDate = date.toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
                
                const statusClass = transaction['Status'] === 'Lunas' ? 'status-lunas' : 
                                  transaction['Status'] === 'Hutang' ? 'status-hutang' : 
                                  transaction['Status'] === 'Manual' ? 'status-manual' : 'status-cicil';
                
                // Calculate total amount for this transaction group
                const totalAmount = transactionGroup.reduce((sum, t) => {
                    return sum + (parseInt(t['Harga Jual (Rp)']) || 0) * (parseInt(t['Jumlah']) || 1);
                }, 0);
                
                transactionItem.innerHTML = `
                    <div class="transaction-icon sales">
                        <i class="bi bi-receipt"></i>
                    </div>
                    <div class="transaction-info">
                        <div class="transaction-title">${transaction['ID Transaksi'] || 'Unknown'}</div>
                        <div class="transaction-date">${formattedDate}  ${transaction['Nama Pelanggan'] || 'Unknown'}</div>
                        <span class="transaction-status ${statusClass}">${transaction['Status'] || 'Unknown'}</span>
                    </div>
                    <div class="transaction-amount">Rp ${totalAmount.toLocaleString('id-ID')}</div>
                    <div class="transaction-actions">
                        <div class="transaction-action" onclick="showReceipt('${transaction['ID Transaksi']}')">
                            <i class="bi bi-printer"></i>
                        </div>
                    </div>
                `;
                container.appendChild(transactionItem);
            });
        }
        
        function updateTransactionHistoryUI() {
            // Update transaction history in riwayat tab
            const container = document.getElementById('transaction-history-list');
            container.innerHTML = '';
            
            if (appData.transactions.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada transaksi</div>';
                return;
            }
            
            // Group transactions by ID Transaksi
            const groupedTransactions = {};
            appData.transactions.forEach(transaction => {
                const id = transaction['ID Transaksi'];
                if (!groupedTransactions[id]) {
                    groupedTransactions[id] = [];
                }
                groupedTransactions[id].push(transaction);
            });
            
            // Sort transactions by date (newest first)
            const sortedTransactions = Object.values(groupedTransactions)
                .sort((a, b) => new Date(b[0]['Tanggal']) - new Date(a[0]['Tanggal']));
            
            sortedTransactions.forEach(transactionGroup => {
                const transaction = transactionGroup[0];
                const transactionItem = document.createElement('li');
                transactionItem.className = 'card-item';
                
                const date = new Date(transaction['Tanggal']);
                const formattedDate = date.toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
                
                const statusClass = transaction['Status'] === 'Lunas' ? 'status-lunas' : 
                                  transaction['Status'] === 'Hutang' ? 'status-hutang' : 
                                  transaction['Status'] === 'Manual' ? 'status-manual' : 'status-cicil';
                
                // Calculate total amount for this transaction group
                const totalAmount = transactionGroup.reduce((sum, t) => {
                    return sum + (parseInt(t['Harga Jual (Rp)']) || 0) * (parseInt(t['Jumlah']) || 1);
                }, 0);
                
                transactionItem.innerHTML = `
                    <div class="card-icon">
                        <i class="bi bi-receipt"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-title">${transaction['ID Transaksi'] || 'Unknown'}</div>
                        <div class="card-subtitle">${formattedDate}  ${transaction['Nama Pelanggan'] || 'Unknown'}</div>
                        <span class="transaction-status ${statusClass}">${transaction['Status'] || 'Unknown'}</span>
                    </div>
                    <div class="card-value">Rp ${totalAmount.toLocaleString('id-ID')}</div>
                    <div class="transaction-actions">
                        <div class="transaction-action" onclick="showReceipt('${transaction['ID Transaksi']}')">
                            <i class="bi bi-printer"></i>
                        </div>
                    </div>
                `;
                container.appendChild(transactionItem);
            });
        }
        
        function updateDebtUI() {
            const container = document.getElementById('debt-list-container');
            container.innerHTML = '';
            
            // Filter transactions with status "Hutang"
            const debtTransactions = appData.transactions.filter(t => t['Status'] === 'Hutang');
            
            if (debtTransactions.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada hutang</div>';
                return;
            }
            
            // Group transactions by ID Transaksi
            const groupedTransactions = {};
            debtTransactions.forEach(transaction => {
                const id = transaction['ID Transaksi'];
                if (!groupedTransactions[id]) {
                    groupedTransactions[id] = [];
                }
                groupedTransactions[id].push(transaction);
            });
            
            // Sort transactions by date (newest first)
            const sortedTransactions = Object.values(groupedTransactions)
                .sort((a, b) => new Date(b[0]['Tanggal']) - new Date(a[0]['Tanggal']));
            
            sortedTransactions.forEach(transactionGroup => {
                const transaction = transactionGroup[0];
                const debtItem = document.createElement('div');
                debtItem.className = 'debt-item';
                
                const date = new Date(transaction['Tanggal']);
                const formattedDate = date.toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
                
                // Calculate total amount for this transaction group
                const totalAmount = transactionGroup.reduce((sum, t) => {
                    return sum + (parseInt(t['Harga Jual (Rp)']) || 0) * (parseInt(t['Jumlah']) || 1);
                }, 0);
                
                // Ambil sisa hutang (seharusnya sama untuk semua transaksi dalam grup)
                const remainingDebt = parseInt(transaction['Sisa Hutang']) || 0;
                
                // Validasi konsistensi
                if (!validateDebtConsistency(transaction['ID Transaksi'])) {
                    console.warn(`Debt inconsistency detected for transaction ${transaction['ID Transaksi']}`);
                }
                
                // Format due date if available
                let dueDateHtml = '';
                if (transaction['Jatuh Tempo']) {
                    const dueDate = new Date(transaction['Jatuh Tempo']);
                    const formattedDueDate = dueDate.toLocaleDateString('id-ID', { 
                        day: '2-digit', 
                        month: 'short', 
                        year: 'numeric' 
                    });
                    
                    // Check if due date is passed
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    dueDate.setHours(0, 0, 0, 0);
                    
                    const isOverdue = dueDate < today;
                    dueDateHtml = `<div class="debt-due-date ${isOverdue ? 'text-danger' : ''}">Jatuh tempo: ${formattedDueDate}</div>`;
                }
                
                debtItem.innerHTML = `
                    <div class="debt-icon">
                        <i class="bi bi-wallet2"></i>
                    </div>
                    <div class="debt-info">
                        <div class="debt-title-text">${transaction['ID Transaksi'] || 'Unknown'}</div>
                        <div class="debt-date">${formattedDate}  ${transaction['Nama Pelanggan'] || 'Unknown'}</div>
                        ${dueDateHtml}
                    </div>
                    <div class="debt-amount">Rp ${remainingDebt.toLocaleString('id-ID')}</div>
                    <div class="debt-actions">
                        <div class="debt-action pay" onclick="showPaymentModal('${transaction['ID Transaksi']}', '${transaction['Nama Pelanggan']}', ${remainingDebt})">
                            <i class="bi bi-cash"></i>
                        </div>
                    </div>
                `;
                
                container.appendChild(debtItem);
            });
        }
        
        function updateWaterStockUI() {
            const waterStock = appData.waterStock;
            const settings = appData.settings;
            const capacity = parseInt(settings['Kapasitas Toren (Liter)'] || 8000);
            const remaining = parseInt(waterStock['Sisa Liter'] || 0);
            const percentage = Math.round((remaining / capacity) * 100);
            
            // Update water level
            document.getElementById('water-level').style.height = `${percentage}%`;
            document.getElementById('water-percentage').textContent = `${percentage}%`;
            
            // Update water info
            document.getElementById('remaining-water').textContent = `${remaining} L`;
            document.getElementById('used-water').textContent = `${parseInt(waterStock['Liter Terpakai'] || 0)} L`;
            document.getElementById('tank-capacity').textContent = `${capacity} L`;
            
            // Update water stock details
            document.getElementById('detail-remaining-water').textContent = `${remaining} L`;
            document.getElementById('detail-used-water').textContent = `${parseInt(waterStock['Liter Terpakai'] || 0)} L`;
            document.getElementById('detail-total-used-water').textContent = `${parseInt(waterStock['Total Liter Terpakai'] || 0)} L`;
            document.getElementById('detail-tank-capacity').textContent = `${capacity} L`;
            document.getElementById('detail-total-cost').textContent = `Rp ${parseInt(settings['Total Biaya Suplai (Rp)'] || 300000).toLocaleString('id-ID')}`;
        }
        
        function updateExpensesUI() {
            const container = document.getElementById('expenses-container');
            container.innerHTML = '';
            
            if (appData.expenses.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada pengeluaran</div>';
                return;
            }
            
            appData.expenses.forEach(expense => {
                const expenseItem = document.createElement('div');
                expenseItem.className = 'expense-item';
                
                const date = new Date(expense['Tanggal']);
                const formattedDate = date.toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
                
                expenseItem.innerHTML = `
                    <div class="expense-icon">
                        <i class="bi bi-cash-coin"></i>
                    </div>
                    <div class="expense-info">
                        <div class="expense-title">${expense['Keterangan'] || 'Unknown'}</div>
                        <div class="expense-date">${formattedDate}</div>
                        <span class="expense-type">${expense['Jenis'] || 'Unknown'}</span>
                    </div>
                    <div class="expense-amount">Rp ${parseInt(expense['Jumlah'] || 0).toLocaleString('id-ID')}</div>
                `;
                container.appendChild(expenseItem);
            });
        }
        
        function updateMonthlyExpense() {
            // Calculate total expenses for current month
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyExpenses = appData.expenses.filter(expense => {
                const expenseDate = new Date(expense['Tanggal']);
                return expenseDate.getMonth() === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            });
            
            const totalExpense = monthlyExpenses.reduce((sum, expense) => {
                return sum + (parseInt(expense['Jumlah']) || 0);
            }, 0);
            
            document.getElementById('monthly-expense').textContent = `Rp ${totalExpense.toLocaleString('id-ID')}`;
        }
        
        function updateNotificationsUI() {
            // Removed notifications from dashboard as requested
        }
        
        function updateNotificationBadge() {
            const enabledCount = appData.notifications.filter(n => n['Status'] === 'enable').length;
            const badge = document.getElementById('notification-count');
            
            if (enabledCount > 0) {
                badge.textContent = enabledCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function updateNotificationDropdown() {
            const container = document.getElementById('notification-dropdown-body');
            container.innerHTML = '';
            
            // Get only enabled notifications
            const enabledNotifications = appData.notifications.filter(n => n['Status'] === 'enable');
            
            if (enabledNotifications.length === 0) {
                container.innerHTML = '<div class="notification-dropdown-empty">Tidak ada notifikasi</div>';
                return;
            }
            
            // Sort notifications by date (newest first)
            const sortedNotifications = [...enabledNotifications]
                .sort((a, b) => new Date(b['Tanggal']) - new Date(a['Tanggal']));
            
            sortedNotifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = 'notification-dropdown-item';
                notificationItem.setAttribute('data-date', notification['Tanggal']);
                
                const date = new Date(notification['Tanggal']);
                const formattedTime = date.toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                notificationItem.innerHTML = `
                    <div class="notification-dropdown-item-info">
                        <div class="notification-dropdown-item-name">${notification['Notifikasi'] || 'Unknown'}</div>
                        <div class="notification-dropdown-item-time">${formattedTime}</div>
                    </div>
                `;
                
                notificationItem.addEventListener('click', function() {
                    // Mark notification as read
                    updateNotificationStatus(notification['Tanggal'], 'disable');
                    
                    // Update UI
                    updateNotificationsUI();
                    updateNotificationBadge();
                    updateNotificationDropdown();
                    
                    // Close dropdown
                    document.getElementById('notification-dropdown').classList.remove('show');
                });
                
                container.appendChild(notificationItem);
            });
        }
        
        function populateProductSelects() {
            const productSelects = [
                document.getElementById('transaction-product-select')
            ];
            
            productSelects.forEach(select => {
                // Clear existing options except the first one
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Add products
                appData.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product['ID Produk'];
                    option.textContent = `${product['Nama Produk']} - Rp ${parseInt(product['Harga Jual (Rp)'] || 0).toLocaleString('id-ID')}`;
                    select.appendChild(option);
                });
            });
        }
        
        function populateCustomerSelects() {
            const customerSelects = [
                document.getElementById('transaction-customer-select')
            ];
            
            customerSelects.forEach(select => {
                // Clear existing options except the first one
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Add customers
                appData.customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer['ID Pelanggan'];
                    option.textContent = customer['Nama'] || 'Unknown';
                    select.appendChild(option);
                });
            });
        }
        
        function updateDashboardStats() {
            // Calculate stats from transactions
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const todayTransactions = appData.transactions.filter(t => {
                const transactionDate = new Date(t['Tanggal']);
                transactionDate.setHours(0, 0, 0, 0);
                return transactionDate.getTime() === today.getTime();
            });
            
            const todaySales = todayTransactions.reduce((sum, t) => {
                return sum + (parseInt(t['Harga Jual (Rp)']) || 0) * (parseInt(t['Jumlah']) || 1);
            }, 0);
            
            // Calculate outstanding debt
            const outstandingDebt = appData.transactions
                .filter(t => t['Status'] !== 'Lunas')
                .reduce((sum, t) => {
                    return sum + (parseInt(t['Sisa Hutang']) || 0);
                }, 0);
            
            // Update UI
            document.getElementById('today-sales').textContent = `Rp ${todaySales.toLocaleString('id-ID')}`;
            document.getElementById('outstanding-debt').textContent = `Rp ${outstandingDebt.toLocaleString('id-ID')}`;
            
            // Water stock from waterStock data
            const waterStock = appData.waterStock;
            const remainingWater = parseInt(waterStock['Sisa Liter'] || 0);
            document.getElementById('water-stock').textContent = `${remainingWater} L`;
            
            // Growth rate (placeholder - would need historical data)
            document.getElementById('growth-rate').textContent = '0%';
            
            // Monthly revenue (placeholder - would need to filter by month)
            document.getElementById('monthly-revenue').textContent = `Rp ${todaySales.toLocaleString('id-ID')}`;
        }
        
        function updateFinancialSummary() {
            // Calculate financial summary from transactions and expenses
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            // Filter transactions for current month
            const monthlyTransactions = appData.transactions.filter(t => {
                const transactionDate = new Date(t['Tanggal']);
                return transactionDate.getMonth() === currentMonth && 
                       transactionDate.getFullYear() === currentYear;
            });
            
            // Calculate total income
            const totalIncome = monthlyTransactions.reduce((sum, t) => {
                return sum + (parseInt(t['Harga Jual (Rp)']) || 0) * (parseInt(t['Jumlah']) || 1);
            }, 0);
            
            // Filter expenses for current month
            const monthlyExpenses = appData.expenses.filter(e => {
                const expenseDate = new Date(e['Tanggal']);
                return expenseDate.getMonth() === currentMonth && 
                       expenseDate.getFullYear() === currentYear;
            });
            
            // Calculate total expenses
            const totalExpense = monthlyExpenses.reduce((sum, e) => {
                return sum + (parseInt(e['Jumlah']) || 0);
            }, 0);
            
            // Calculate total debt
            const totalDebt = appData.transactions
                .filter(t => t['Status'] !== 'Lunas')
                .reduce((sum, t) => {
                    return sum + (parseInt(t['Sisa Hutang']) || 0);
                }, 0);
            
            // Calculate net profit
            const netProfit = totalIncome - totalExpense;
            
            // Update UI
            document.getElementById('total-income').textContent = `Rp ${totalIncome.toLocaleString('id-ID')}`;
            document.getElementById('total-expense').textContent = `Rp ${totalExpense.toLocaleString('id-ID')}`;
            document.getElementById('total-debt').textContent = `Rp ${totalDebt.toLocaleString('id-ID')}`;
            document.getElementById('net-profit').textContent = `Rp ${netProfit.toLocaleString('id-ID')}`;
        }
        
        function updateSalesChart() {
            const chartContainer = document.getElementById('sales-chart-bars');
            chartContainer.innerHTML = '';
            
            // Get the last 7 days
            const days = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
            const today = new Date();
            const chartData = [];
            
            // Initialize chart data with 0 values
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dayName = days[date.getDay()];
                
                chartData.push({
                    day: dayName,
                    value: 0,
                    height: 5 // Minimum height
                });
            }
            
            // Calculate sales for each day
            appData.transactions.forEach(transaction => {
                const transactionDate = new Date(transaction['Tanggal']);
                const daysDiff = Math.floor((today - transactionDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff >= 0 && daysDiff < 7) {
                    const dayIndex = 6 - daysDiff;
                    const amount = (parseInt(transaction['Harga Jual (Rp)']) || 0) * (parseInt(transaction['Jumlah']) || 1);
                    
                    chartData[dayIndex].value += amount;
                }
            });
            
            // Find the maximum value for scaling
            const maxValue = Math.max(...chartData.map(d => d.value), 1);
            
            // Update chart data with scaled heights
            chartData.forEach(data => {
                data.height = Math.max(5, Math.min(95, (data.value / maxValue) * 90));
            });
            
            // Create chart bars
            chartData.forEach(data => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${data.height}%`;
                
                // Format value for display
                let displayValue;
                if (data.value >= 1000000) {
                    displayValue = `${(data.value / 1000000).toFixed(1)}M`;
                } else if (data.value >= 1000) {
                    displayValue = `${(data.value / 1000).toFixed(1)}K`;
                } else {
                    displayValue = data.value.toString();
                }
                
                bar.setAttribute('data-value', displayValue);
                chartContainer.appendChild(bar);
            });
        }
        
        function updateWaterLevel() {
            // Update water level visualization
            const waterStock = appData.waterStock;
            const settings = appData.settings;
            const capacity = parseInt(settings['Kapasitas Toren (Liter)'] || 8000);
            const remaining = parseInt(waterStock['Sisa Liter'] || 0);
            const percentage = Math.round((remaining / capacity) * 100);
            
            document.getElementById('water-level').style.height = `${percentage}%`;
            document.getElementById('water-percentage').textContent = `${percentage}%`;
        }
        
        function updateTransactionDate() {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('id-ID', { 
                day: '2-digit', 
                month: 'long', 
                year: 'numeric' 
            });
            document.getElementById('transaction-date').textContent = formattedDate;
        }
        
        function updateStockHistory() {
            const container = document.getElementById('stock-history-container');
            container.innerHTML = '';
            
            // Get water refill data from expenses
            const stockHistory = appData.expenses
                .filter(e => e['Jenis'] === 'Stok Air')
                .map(expense => {
                    return {
                        date: expense['Tanggal'],
                        description: expense['Keterangan'] || 'Penambahan stok air',
                        amount: parseInt(expense['Jumlah']) || 0,
                        type: 'refill'
                    };
                });
            
            // Sort by date (newest first)
            stockHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Show only the 10 most recent
            const recentHistory = stockHistory.slice(0, 10);
            
            if (recentHistory.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada riwayat penambahan stok air</div>';
                return;
            }
            
            recentHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'stock-history-item';
                
                const date = new Date(item.date);
                const formattedDate = date.toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
                
                historyItem.innerHTML = `
                    <div class="stock-history-info">
                        <div class="stock-history-date">${formattedDate}</div>
                        <div class="stock-history-desc">${item.description}</div>
                    </div>
                    <div class="stock-history-amount positive">Rp ${item.amount.toLocaleString('id-ID')}</div>
                `;
                
                container.appendChild(historyItem);
            });
        }
        
        function updateTopProducts() {
            const container = document.getElementById('top-products-container');
            container.innerHTML = '';
            
            if (appData.products.length === 0 || appData.transactions.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada data produk terlaris</div>';
                return;
            }
            
            // Calculate product sales
            const productSales = {};
            
            appData.transactions.forEach(transaction => {
                const productName = transaction['Produk'];
                const quantity = parseInt(transaction['Jumlah']) || 1;
                const price = parseInt(transaction['Harga Jual (Rp)']) || 0;
                
                if (productName) {
                    if (!productSales[productName]) {
                        productSales[productName] = {
                            name: productName,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    
                    productSales[productName].quantity += quantity;
                    productSales[productName].revenue += price * quantity;
                }
            });
            
            // Convert to array and sort by quantity
            const sortedProducts = Object.values(productSales)
                .sort((a, b) => b.quantity - a.quantity)
                .slice(0, 3); // Get top 3 products only
            
            // Create top products list
            const productList = document.createElement('ul');
            productList.className = 'top-product-list';
            
            sortedProducts.forEach((product, index) => {
                const productItem = document.createElement('li');
                productItem.className = 'top-product-item';
                
                let rankClass = '';
                let rankText = (index + 1).toString();
                
                if (index === 0) {
                    rankClass = 'first';
                } else if (index === 1) {
                    rankClass = 'second';
                } else if (index === 2) {
                    rankClass = 'third';
                }
                
                productItem.innerHTML = `
                    <div class="product-rank ${rankClass}">${rankText}</div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-sales">${product.quantity} terjual  Rp ${product.revenue.toLocaleString('id-ID')}</div>
                    </div>
                `;
                
                productList.appendChild(productItem);
            });
            
            container.appendChild(productList);
        }
        
        function updateActiveCustomers() {
            const container = document.getElementById('active-customers-container');
            container.innerHTML = '';
            
            if (appData.customers.length === 0 || appData.transactions.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada data pelanggan</div>';
                return;
            }
            
            // Calculate customer stats
            const customerStats = {};
            
            appData.transactions.forEach(transaction => {
                const customerId = transaction['ID Pelanggan'];
                const customerName = transaction['Nama Pelanggan'];
                const quantity = parseInt(transaction['Jumlah']) || 1;
                const price = parseInt(transaction['Harga Jual (Rp)']) || 0;
                
                if (customerId && customerName) {
                    if (!customerStats[customerId]) {
                        customerStats[customerId] = {
                            id: customerId,
                            name: customerName,
                            transactions: 0,
                            quantity: 0,
                            revenue: 0
                        };
                    }
                    
                    customerStats[customerId].transactions += 1;
                    customerStats[customerId].quantity += quantity;
                    customerStats[customerId].revenue += price * quantity;
                }
            });
            
            // Convert to array and sort by revenue
            const sortedCustomers = Object.values(customerStats)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 3); // Get top 3 customers
            
            sortedCustomers.forEach(customer => {
                const customerItem = document.createElement('div');
                customerItem.className = 'customer-item';
                
                // Get initials for avatar
                const name = customer.name || 'Unknown';
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                customerItem.innerHTML = `
                    <div class="customer-avatar">${initials}</div>
                    <div class="customer-info">
                        <div class="customer-name">${name}</div>
                        <div class="customer-stats">${customer.transactions} transaksi  ${customer.quantity} galon</div>
                    </div>
                    <div class="customer-value">Rp ${customer.revenue.toLocaleString('id-ID')}</div>
                `;
                
                container.appendChild(customerItem);
            });
        }
        
        function calculateDailySales() {
            // Reset daily sales data
            appData.dailySales = {};
            
            // Calculate sales for each day
            appData.transactions.forEach(transaction => {
                const date = new Date(transaction['Tanggal']);
                const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                
                if (!appData.dailySales[dateStr]) {
                    appData.dailySales[dateStr] = 0;
                }
                
                const amount = (parseInt(transaction['Harga Jual (Rp)']) || 0) * (parseInt(transaction['Jumlah']) || 1);
                appData.dailySales[dateStr] += amount;
            });
        }
        
        // Update water level threshold for refill button
        function updateWaterLevelThreshold() {
            const waterStock = appData.waterStock;
            const settings = appData.settings;
            const capacity = parseInt(settings['Kapasitas Toren (Liter)'] || 8000);
            const remaining = parseInt(waterStock['Sisa Liter'] || 0);
            
            // Enable refill button if water is below 50 liters
            const refillButton = document.getElementById('refill-water-btn');
            if (remaining < 50) {
                refillButton.disabled = false;
            } else {
                refillButton.disabled = true;
            }
        }
        
        // Disable/Enable buttons during processing
        function setProcessingState(isProcessing) {
            appData.processing = isProcessing;
            
            // Disable all buttons during processing
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (isProcessing) {
                    button.disabled = true;
                } else {
                    // Only enable buttons that should be enabled
                    if (!button.id.includes('refill-water-btn') || 
                          (button.id.includes('refill-water-btn') && 
                           parseInt(appData.waterStock['Sisa Liter'] || 0) < 50)) {
                        button.disabled = false;
                    }
                }
            });
            
            // Update FAB button
            const fabButton = document.getElementById('fab-button');
            if (isProcessing) {
                fabButton.style.opacity = '0.5';
                fabButton.style.pointerEvents = 'none';
            } else {
                fabButton.style.opacity = '1';
                fabButton.style.pointerEvents = 'auto';
            }
        }
        
        // Cashier Functions
        // PERBAIKAN: Fungsi addToCart yang diperbaiki
        function addToCart(product) {
            // Check if product already in cart
            const existingItem = appData.cart.find(item => item.id === product['ID Produk']);
            
            if (existingItem) {
                // Increase quantity by 1
                existingItem.quantity += 1;
            } else {
                // Add new item to cart with quantity 1
                appData.cart.push({
                    id: product['ID Produk'],
                    name: product['Nama Produk'],
                    price: parseInt(product['Harga Jual (Rp)']) || 0,
                    quantity: 1
                });
            }
            
            // Update cart UI
            updateCartUI();
            updateCartDropdown();
            updateCartBadge();
            
            // Update product view based on current view
            if (appData.productView === 'list') {
                updateProductsListView();
            } else {
                updateProductsGridView();
            }
        }
        
        function updateCartUI() {
            const container = document.getElementById('cart-items-container');
            container.innerHTML = '';
            
            if (appData.cart.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">Belum ada item yang dipilih</div>';
                updateCartSummary();
                return;
            }
            
            appData.cart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">Rp ${item.price.toLocaleString('id-ID')} x ${item.quantity}</div>
                    </div>
                    <div class="cart-item-quantity">
                        <div class="quantity-btn" onclick="updateCartItemQuantity('${item.id}', -1)">
                            <i class="bi bi-dash"></i>
                        </div>
                        <div class="quantity-value">${item.quantity}</div>
                        <div class="quantity-btn" onclick="updateCartItemQuantity('${item.id}', 1)">
                            <i class="bi bi-plus"></i>
                        </div>
                    </div>
                    <div class="cart-item-total">Rp ${(item.price * item.quantity).toLocaleString('id-ID')}</div>
                `;
                
                container.appendChild(cartItem);
            });
            
            updateCartSummary();
        }
        
        function updateCartDropdown() {
            const container = document.getElementById('cart-dropdown-body');
            container.innerHTML = '';
            
            if (appData.cart.length === 0) {
                container.innerHTML = '<div class="cart-dropdown-empty">Keranjang kosong</div>';
                document.getElementById('cart-dropdown-total').textContent = 'Rp 0';
                return;
            }
            
            appData.cart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-dropdown-item';
                
                cartItem.innerHTML = `
                    <div class="cart-dropdown-item-info">
                        <div class="cart-dropdown-item-name">${item.name}</div>
                        <div class="cart-dropdown-item-quantity">${item.quantity} x Rp ${item.price.toLocaleString('id-ID')}</div>
                    </div>
                    <div class="cart-dropdown-item-price">Rp ${(item.price * item.quantity).toLocaleString('id-ID')}</div>
                `;
                
                container.appendChild(cartItem);
            });
            
            // Update total
            const total = appData.cart.reduce((sum, item) => {
                return sum + (item.price * item.quantity);
            }, 0);
            
            document.getElementById('cart-dropdown-total').textContent = `Rp ${total.toLocaleString('id-ID')}`;
        }
        
        function updateCartBadge() {
            const totalItems = appData.cart.reduce((sum, item) => {
                return sum + item.quantity;
            }, 0);
            
            const badge = document.getElementById('cart-count');
            
            if (totalItems > 0) {
                badge.textContent = totalItems;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function updateCartItemQuantity(productId, change) {
            const item = appData.cart.find(item => item.id === productId);
            
            if (item) {
                item.quantity += change;
                
                if (item.quantity <= 0) {
                    // Remove item from cart
                    appData.cart = appData.cart.filter(cartItem => cartItem.id !== productId);
                    
                    // Remove from selected products
                    if (appData.selectedProducts[productId]) {
                        appData.selectedProducts[productId] = 0;
                        if (appData.selectedProducts[productId] <= 0) {
                            delete appData.selectedProducts[productId];
                        }
                    }
                }
                
                updateCartUI();
                updateCartDropdown();
                updateCartBadge();
                
                // Update product view based on current view
                if (appData.productView === 'list') {
                    updateProductsListView();
                } else {
                    updateProductsGridView();
                }
            }
        }
        
        function updateCartSummary() {
            const subtotal = appData.cart.reduce((sum, item) => {
                return sum + (item.price * item.quantity);
            }, 0);
            
            const discount = 0; // No discount for now
            const total = subtotal - discount;
            
            document.getElementById('cart-subtotal').textContent = `Rp ${subtotal.toLocaleString('id-ID')}`;
            document.getElementById('cart-discount').textContent = `Rp ${discount.toLocaleString('id-ID')}`;
            document.getElementById('cart-total').textContent = `Rp ${total.toLocaleString('id-ID')}`;
        }
        
        function clearCart() {
            appData.cart = [];
            appData.selectedProducts = {};
            
            // Update product view based on current view
            if (appData.productView === 'list') {
                updateProductsListView();
            } else {
                updateProductsGridView();
            }
            
            updateCartUI();
            updateCartDropdown();
            updateCartBadge();
        }
        
        // PERBAIKAN: Fungsi checkout() yang diperbaiki untuk memastikan konsistensi data hutang
        async function checkout() {
            // Check if already processing
            if (appData.processing) {
                showToast('Proses sedang berlangsung, harap tunggu', 'warning');
                return;
            }
            
            // Get customer ID
            let customerId = '';
            let customerName = '';
            
            if (appData.selectedCustomer) {
                customerId = appData.selectedCustomer['ID Pelanggan'];
                customerName = appData.selectedCustomer['Nama'];
            } else {
                // Generate random customer ID if none selected
                customerId = generateCustomerId();
                customerName = document.getElementById('cashier-customer-input').value || customerId;
            }
            
            if (appData.cart.length === 0) {
                showToast('Keranjang belanja kosong', 'warning');
                return;
            }
            
            // Get manual payment amount if payment method is Manual
            let manualPaymentAmount = 0;
            if (appData.selectedPaymentMethod === 'Manual') {
                manualPaymentAmount = parseInt(document.getElementById('manual-payment-amount').value) || 0;
                
                if (manualPaymentAmount <= 0) {
                    showToast('Silakan masukkan jumlah bayar yang valid', 'warning');
                    return;
                }
            }
            
            // Get due date if payment method is Hutang
            let dueDate = '';
            if (appData.selectedPaymentMethod === 'Hutang') {
                dueDate = document.getElementById('transaction-due-date').value;
                
                if (!dueDate) {
                    showToast('Silakan pilih tanggal jatuh tempo', 'warning');
                    return;
                }
            }
            
            // Calculate totals
            const subtotal = appData.cart.reduce((sum, item) => {
                return sum + (item.price * item.quantity);
            }, 0);
            
            // PERBAIKAN: Hitung sisa hutang dengan benar berdasarkan metode pembayaran
            let remainingDebt = 0;
            if (appData.selectedPaymentMethod === 'Lunas') {
                remainingDebt = 0;
            } else if (appData.selectedPaymentMethod === 'Manual') {
                // Pastikan manualPaymentAmount tidak melebihi subtotal
                manualPaymentAmount = Math.min(manualPaymentAmount, subtotal);
                remainingDebt = subtotal - manualPaymentAmount;
            } else { // Hutang
                remainingDebt = subtotal;
            }
            
            // Set processing state
            setProcessingState(true);
            
            // Show processing overlay
            showProcessingOverlay();
            
            // Create transactions for each item in cart
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const randomStr = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const transactionId = `TRX-${dateStr}-${randomStr}`;
            
            let allTransactionsSaved = true;
            let totalWaterUsed = 0;
            
            for (const item of appData.cart) {
                // Get product details
                const product = appData.products.find(p => p['ID Produk'] === item.id);
                
                if (!product) {
                    allTransactionsSaved = false;
                    continue;
                }
                
                // Calculate values
                const price = parseInt(product['Harga Jual (Rp)']) || 0;
                const cost = parseInt(product['Harga Pokok (Rp)']) || 0;
                const profit = price - cost;
                const totalPrice = price * item.quantity;
                const totalCost = cost * item.quantity;
                const totalProfit = profit * item.quantity;
                
                // Calculate water used
                const productLiters = parseInt(product['Liter']) || 0;
                totalWaterUsed += productLiters * item.quantity;
                
                // Prepare transaction data
                const transactionData = {
                    'Tanggal': now.toISOString(),
                    'ID Transaksi': transactionId,
                    'ID Pelanggan': customerId,
                    'Nama Pelanggan': customerName,
                    'Produk': product['Nama Produk'],
                    'Harga Jual (Rp)': price,
                    'Harga Pokok (Rp)': cost,
                    'Laba Kotor (Rp)': profit,
                    'Status': appData.selectedPaymentMethod,
                    // PERBAIKAN: Gunakan nilai remainingDebt yang sudah dihitung dengan benar
                    'Sisa Hutang': remainingDebt,
                    'Jatuh Tempo': dueDate,
                    'Jumlah': item.quantity,
                    'Jenis Transaksi': 'Penjualan',
                    'ID Transaksi Induk': transactionId,
                    // PERBAIKAN: Gunakan nilai yang konsisten
                    'Total Hutang Awal': remainingDebt,
                    'Jumlah Bayar Manual': appData.selectedPaymentMethod === 'Manual' ? manualPaymentAmount : 0
                };
                
                // Save transaction
                const success = await insertData('Transaksi', transactionData);
                
                if (!success) {
                    allTransactionsSaved = false;
                }
            }
            
            if (allTransactionsSaved) {
                // Update water stock
                const waterStock = appData.waterStock;
                const settings = appData.settings;
                const currentCapacity = parseInt(settings['Kapasitas Toren (Liter)'] || 8000);
                const currentRemaining = parseInt(waterStock['Sisa Liter'] || 0);
                const currentUsed = parseInt(waterStock['Liter Terpakai'] || 0);
                const currentTotalUsed = parseInt(waterStock['Total Liter Terpakai'] || 0);
                
                const newRemaining = Math.max(0, currentRemaining - totalWaterUsed);
                const newUsed = currentUsed + totalWaterUsed;
                const newTotalUsed = currentTotalUsed + totalWaterUsed;
                
                // Update water stock (only update, not insert)
                const waterStockData = {
                    'Kapasitas Toren': currentCapacity,
                    'Sisa Liter': newRemaining,
                    'Liter Terpakai': newUsed,
                    'Total Liter Terpakai': newTotalUsed,
                    'Total Biaya Suplai (Rp)': waterStock['Total Biaya Suplai (Rp)'] || 300000
                };
                
                // Update water stock
                const waterStockSuccess = await updateData('Stok Air', 2, waterStockData);
                
                if (waterStockSuccess) {
                    // Clear cart
                    clearCart();
                    
                    // Refresh data
                    loadTransactions();
                    loadWaterStock();
                    updateDashboardStats();
                    updateFinancialSummary();
                    updateTopProducts();
                    updateActiveCustomers();
                    updateWaterStockUI();
                    updateStockHistory();
                    updateWaterLevelThreshold();
                    calculateDailySales();
                    updateSalesChart();
                    updateDebtUI();
                    
                    // Add notification
                    const notificationData = {
                        'Tanggal': new Date().toISOString(),
                        'Notifikasi': `Transaksi berhasil! Total: Rp ${subtotal.toLocaleString('id-ID')}`,
                        'Status': 'enable'
                    };
                    insertData('Notifikasi', notificationData);
                    
                    // Switch to riwayat tab
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    
                    const riwayatTab = document.querySelector('.nav-item[data-tab="riwayat-tab"]');
                    const riwayatContent = document.getElementById('riwayat-tab');
                    
                    riwayatTab.classList.add('active');
                    riwayatContent.classList.add('active');
                    
                    // Update FAB button
                    updateFabButton();
                    
                    // Update search box visibility
                    updateSearchBoxVisibility('riwayat-tab');
                    
                    // Update banner content
                    updateBannerContent('riwayat-tab');
                }
            } else {
                // Add notification for failed transaction
                const notificationData = {
                    'Tanggal': new Date().toISOString(),
                    'Notifikasi': `Transaksi gagal! Total: Rp ${subtotal.toLocaleString('id-ID')}`,
                    'Status': 'enable'
                };
                insertData('Notifikasi', notificationData);
            }
            
            // Hide processing overlay
            hideProcessingOverlay();
            
            // Reset processing state
            setProcessingState(false);
        }
        
        // Action Functions
        async function saveTransactionFromModal() {
            // Check if already processing
            if (appData.processing) {
                showToast('Proses sedang berlangsung, harap tunggu', 'warning');
                return;
            }
            
            // Get form values
            const customerId = document.getElementById('transaction-customer-select').value;
            const productId = document.getElementById('transaction-product-select').value;
            const quantity = document.getElementById('transaction-quantity').value;
            const paymentStatus = document.getElementById('transaction-payment-status').value;
            const dueDate = document.getElementById('transaction-due-date').value;
            
            // Validate inputs
            if (!customerId || customerId === 'Pilih pelanggan') {
                showToast('Silakan pilih pelanggan', 'warning');
                return;
            }
            
            if (!productId || productId === 'Pilih produk') {
                showToast('Silakan pilih produk', 'warning');
                return;
            }
            
            if (!quantity || quantity <= 0) {
                showToast('Silakan masukkan jumlah yang valid', 'warning');
                return;
            }
            
            // Get customer and product details
            const customer = appData.customers.find(c => c['ID Pelanggan'] === customerId);
            const product = appData.products.find(p => p['ID Produk'] === productId);
            
            if (!customer || !product) {
                showToast('Data pelanggan atau produk tidak ditemukan', 'danger');
                return;
            }
            
            // Calculate values
            const price = parseInt(product['Harga Jual (Rp)']) || 0;
            const cost = parseInt(product['Harga Pokok (Rp)']) || 0;
            const profit = price - cost;
            const totalPrice = price * parseInt(quantity);
            const totalCost = cost * parseInt(quantity);
            const totalProfit = profit * parseInt(quantity);
            
            // Calculate water used
            const productLiters = parseInt(product['Liter']) || 0;
            const totalWaterUsed = productLiters * parseInt(quantity);
            
            // Generate transaction ID
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const randomStr = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const transactionId = `TRX-${dateStr}-${randomStr}`;
            
            // PERBAIKAN: Hitung sisa hutang dengan benar
            let remainingDebt = 0;
            if (paymentStatus === 'Lunas') {
                remainingDebt = 0;
            } else { // Hutang atau Manual
                remainingDebt = totalPrice;
            }
            
            // Set processing state
            setProcessingState(true);
            
            // Show processing overlay
            showProcessingOverlay();
            
            // Prepare transaction data
            const transactionData = {
                'Tanggal': now.toISOString(),
                'ID Transaksi': transactionId,
                'ID Pelanggan': customerId,
                'Nama Pelanggan': customer['Nama'],
                'Produk': product['Nama Produk'],
                'Harga Jual (Rp)': price,
                'Harga Pokok (Rp)': cost,
                'Laba Kotor (Rp)': profit,
                'Status': paymentStatus,
                // PERBAIKAN: Gunakan nilai remainingDebt yang konsisten
                'Sisa Hutang': remainingDebt,
                'Jatuh Tempo': dueDate || '',
                'Jumlah': quantity,
                'Jenis Transaksi': 'Penjualan',
                'ID Transaksi Induk': transactionId,
                // PERBAIKAN: Gunakan nilai yang konsisten
                'Total Hutang Awal': remainingDebt,
                'Jumlah Bayar Manual': 0
            };
            
            // Save transaction
            const success = await insertData('Transaksi', transactionData);
            
            if (success) {
                // Update water stock
                const waterStock = appData.waterStock;
                const settings = appData.settings;
                const currentCapacity = parseInt(settings['Kapasitas Toren (Liter)'] || 8000);
                const currentRemaining = parseInt(waterStock['Sisa Liter'] || 0);
                const currentUsed = parseInt(waterStock['Liter Terpakai'] || 0);
                const currentTotalUsed = parseInt(waterStock['Total Liter Terpakai'] || 0);
                
                const newRemaining = Math.min(currentCapacity, currentRemaining + parseInt(amount));
                const newTotalUsed = currentTotalUsed; // Total used should not reset
                const newTotalCost = currentTotalCost + totalCost;
                
                // Update water stock (only update, not insert)
                const waterStockData = {
                    'Kapasitas Toren': currentCapacity,
                    'Sisa Liter': newRemaining,
                    'Liter Terpakai': 0, // Reset daily usage
                    'Total Liter Terpakai': newTotalUsed,
                    'Total Biaya Suplai (Rp)': newTotalCost
                };
                
                // Update water stock
                const waterStockSuccess = await updateData('Stok Air', 2, waterStockData);
                
                if (waterStockSuccess) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addTransactionModal'));
                    modal.hide();
                    
                    // Reset form
                    document.getElementById('transaction-customer-select').value = 'Pilih pelanggan';
                    document.getElementById('transaction-product-select').value = 'Pilih produk';
                    document.getElementById('transaction-quantity').value = 1;
                    document.getElementById('transaction-payment-status').value = 'Lunas';
                    document.getElementById('transaction-due-date').value = '';
                    
                    // Refresh data
                    loadTransactions();
                    loadWaterStock();
                    updateDashboardStats();
                    updateFinancialSummary();
                    updateTopProducts();
                    updateActiveCustomers();
                    updateWaterStockUI();
                    updateStockHistory();
                    updateWaterLevelThreshold();
                    calculateDailySales();
                    updateSalesChart();
                    updateDebtUI();
                    
                    // Add notification
                    const notificationData = {
                        'Tanggal': new Date().toISOString(),
                        'Notifikasi': `Transaksi berhasil! Total: Rp ${totalPrice.toLocaleString('id-ID')}`,
                        'Status': 'enable'
                    };
                    insertData('Notifikasi', notificationData);
                }
            } else {
                // Add notification for failed transaction addition
                const notificationData = {
                    'Tanggal': new Date().toISOString(),
                    'Notifikasi': `Gagal menambahkan transaksi: ${product['Nama Produk']}`,
                    'Status': 'enable'
                };
                insertData('Notifikasi', notificationData);
            }
            
            // Hide processing overlay
            hideProcessingOverlay();
            
            // Reset processing state
            setProcessingState(false);
        }
        
        async function saveProduct() {
            // Check if already processing
            if (appData.processing) {
                showToast('Proses sedang berlangsung, harap tunggu', 'warning');
                return;
            }
            
            // Get form values
            const productName = document.getElementById('product-name').value;
            const productLiter = document.getElementById('product-liter').value;
            const productCost = document.getElementById('product-cost').value;
            const productPrice = document.getElementById('product-price').value;
            
            // Validate inputs
            if (!productName) {
                showToast('Silakan masukkan nama produk', 'warning');
                return;
            }
            
            if (!productLiter || productLiter <= 0) {
                showToast('Silakan masukkan jumlah liter yang valid', 'warning');
                return;
            }
            
            if (!productCost || productCost < 0) {
                showToast('Silakan masukkan harga pokok yang valid', 'warning');
                return;
            }
            
            if (!productPrice || productPrice <= 0) {
                showToast('Silakan masukkan harga jual yang valid', 'warning');
                return;
            }
            
            // Generate product ID
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const randomStr = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const productId = `PRD-${dateStr}-${randomStr}`;
            
            // Set processing state
            setProcessingState(true);
            
            // Show processing overlay
            showProcessingOverlay();
            
            // Prepare product data
            const productData = {
                'ID Produk': productId,
                'Nama Produk': productName,
                'Liter': productLiter,
                'Harga Pokok (Rp)': productCost,
                'Harga Jual (Rp)': productPrice
            };
            
            // Save product
            const success = await insertData('Produk', productData);
            
            if (success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('product-name').value = '';
                document.getElementById('product-liter').value = '';
                document.getElementById('product-cost').value = '';
                document.getElementById('product-price').value = '';
                
                // Refresh data
                loadProducts();
                
                // Add notification
                const notificationData = {
                    'Tanggal': new Date().toISOString(),
                    'Notifikasi': `Produk baru berhasil ditambahkan: ${productName}`,
                    'Status': 'enable'
                };
                insertData('Notifikasi', notificationData);
            } else {
                // Add notification for failed product addition
                const notificationData = {
                    'Tanggal': new Date().toISOString(),
                    'Notifikasi': `Gagal menambahkan produk: ${productName}`,
                    'Status': 'enable'
                };
                insertData('Notifikasi', notificationData);
            }
            
            // Hide processing overlay
            hideProcessingOverlay();
            
            // Reset processing state
            setProcessingState(false);
        }
        
        async function saveCustomer() {
            // Check if already processing
            if (appData.processing) {
                showToast('Proses sedang berlangsung, harap tunggu', 'warning');
                return;
            }
            
            // Get form values
            const customerName = document.getElementById('customer-name').value;
            const customerContact = document.getElementById('customer-contact').value;
            const customerAddress = document.getElementById('customer-address').value;
            const customerDeposit = document.getElementById('customer-deposit').value || 0;
            const customerMaps = document.getElementById('customer-maps').value;
            
            // Validate inputs
            if (!customerName) {
                showToast('Silakan masukkan nama pelanggan', 'warning');
                return;
            }
            
            if (!customerContact) {
                showToast('Silakan masukkan kontak pelanggan', 'warning');
                return;
            }
            
            // Generate customer ID
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const randomStr = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            const customerId = `CST-${dateStr}-${randomStr}`;
            
            // Set processing state
            setProcessingState(true);
            
            // Show processing overlay
            showProcessingOverlay();
            
            // Prepare customer data
            const customerData = {
                'ID Pelanggan': customerId,
                'Nama': customerName,
                'Kontak': customerContact,
                'Alamat': customerAddress,
                'Galon Titipan': customerDeposit,
                'Maps': customerMaps
            };
            
            // Save customer
            const success = await insertData('Pelanggan', customerData);
            
            if (success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-contact').value = '';
                document.getElementById('customer-address').value = '';
                document.getElementById('customer-deposit').value = '0';
                document.getElementById('customer-maps').value = '';
                
                // Refresh data
                loadCustomers();
                
                // Add notification
                const notificationData = {
                    'Tanggal': new Date().toISOString(),
                    'Notifikasi': `Pelanggan baru berhasil ditambahkan: ${customerName}`,
                    'Status': 'enable'
                };
                insertData('Notifikasi', notificationData);
            } else {
                // Add notification for failed customer addition
                const notificationData = {
                    'Tanggal': new Date().toISOString(),
                    'Notifikasi': `Gagal menambahkan pelanggan: ${customerName}`,
                    'Status': 'enable'
                };
                insertData('Notifikasi', notificationData);
            }
            
            // Hide processing overlay
            hideProcessingOverlay();
            
            // Reset processing state
            setProcessingState(false);
        }
        
        async function saveCustomerName() {
            const customerId = document.getElementById('edit-customer-id').value;
            const newName = document.getElementById('edit-customer-name').value;
            const newContact = document.getElementById('edit-customer-contact').value;
            const newAddress = document.getElementById('edit-customer-address').value;
            const newDeposit = document.getElementById('edit-customer-deposit').value;
            const newMaps = document.getElementById('edit-customer-maps').value;
            
            if (!newName) {
                showToast('Nama pelanggan tidak boleh kosong', 'warning');
                return;
            }
            
            // Cari pelanggan di appData
            const customerIndex = appData.customers.findIndex(c => c['ID Pelanggan'] === customerId);
            
            if (customerIndex === -1) {
                showToast('Pelanggan tidak ditemukan', 'danger');
                return;
            }
            
            // Update nama pelanggan di appData
            appData.customers[customerIndex]['Nama'] = newName;
            appData.customers[customerIndex]['Kontak'] = newContact;
            appData.customers[customerIndex]['Alamat'] = newAddress;
            appData.customers[customerIndex]['Galon Titipan'] = newDeposit;
            appData.customers[customerIndex]['Maps'] = newMaps;
            
            // Update di spreadsheet
            const success = await updateData('Pelanggan', customerIndex + 2, {
                'Nama': newName,
                'Kontak': newContact,
                'Alamat': newAddress,
                'Galon Titipan': newDeposit,
                'Maps': newMaps
            });
            
            if (success) {
                // Update UI
                updateCustomersUI();
                
                // Tutup modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editCustomerModal'));
                modal.hide();
                
                showToast('Data pelanggan berhasil diperbarui', 'success');
            } else {
                showToast('Gagal memperbarui data pelanggan', 'danger');
            }
        }
        
        async function deleteCustomer() {
            const customerId = document.getElementById('edit-customer-id').value;
            
            if (!confirm('Apakah Anda yakin ingin menghapus pelanggan ini?')) {
                return;
            }
            
            // Cari pelanggan di appData
            const customerIndex = appData.customers.findIndex(c => c['ID Pelanggan'] === customerId);
            
            if (customerIndex === -1) {
                showToast('Pelanggan tidak ditemukan', 'danger');
                return;
            }
            
            // Hapus pelanggan dari appData
            appData.customers.splice(customerIndex, 1);
            
            // Update UI
            updateCustomersUI();
            
            // Tutup modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editCustomerModal'));
            modal.hide();
            
            showToast('Pelanggan berhasil dihapus', 'success');
        }
        
        async function saveExpense() {
            // Check if already processing
            if (appData.processing) {
                showToast('Proses sedang berlangsung, harap tunggu', 'warning');
                return;
            }
            
            // Get form values
            const expenseType = document.getElementById('expense-type').value;
            const expenseDescription = document.getElementById('expense-description').value;
            const expenseAmount = document.getElementById('expense-amount').value;
            const expenseDate = document.getElementById('expense-date').value;
            
            // Validate inputs
            if (!expenseDescription) {
                showToast('Silakan masukkan keterangan pengeluaran', 'warning');
                return;
            }
            
            if (!expenseAmount || expenseAmount <= 0) {
                showToast('Silakan masukkan jumlah yang valid', 'warning');
                return;
            }
            
            if (!expenseDate) {
                showToast('Silakan pilih tanggal', 'warning');
                return;
            }
            
            // Set processing state
            setProcessingState(true);
            
            // Show processing overlay
            showProcessingOverlay();
            
            // Prepare expense data
            const expenseData = {
                'Tanggal': expenseDate,
                'Keterangan': expenseDescription,
                'Jenis': expenseType,
                'Jumlah': expenseAmount,
                'Saldo': '-' + expenseAmount // Placeholder for actual balance calculation
            };
            
            // Save expense
            const success = await insertData('Pengeluaran', expenseData);
            
            if (success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addExpenseModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('expense-type').value = 'Operasional';
                document.getElementById('expense-description').value = '';
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-date').value = '';
                
                // Refresh data
                loadExpenses();
                updateFinancialSummary();
                updateMonthlyExpense();
                
                // Add notification
                const notificationData = {
                    'Tanggal': new Date().toISOString(),
                    'Notifikasi': `Pengeluaran baru berhasil ditambahkan: ${expenseDescription}`,
                    'Status': 'enable'
                };
                insertData('Notifikasi', notificationData);
            } else {
                // Add notification for failed expense addition
                const notificationData = {
                    'Tanggal': new Date().toISOString(),
                    'Notifikasi': `Gagal menambahkan pengeluaran: ${expenseDescription}`,
                    'Status': 'enable'
                };
                insertData('Notifikasi', notificationData);
            }
            
            // Hide processing overlay
            hideProcessingOverlay();
            
            // Reset processing state
            setProcessingState(false);
        }
        
        async function saveRefill() {
            // Check if already processing
            if (appData.processing) {
                showToast('Proses sedang berlangsung, harap tunggu', 'warning');
                return;
            }
            
            // Get form values
            const amount = document.getElementById('refill-amount').value;
            const date = document.getElementById('refill-date').value;
            const description = document.getElementById('refill-description').value;
            
            // Validate inputs
            if (!amount || amount <= 0) {
                showToast('Silakan masukkan jumlah liter yang valid', 'warning');
                return;
            }
            
            if (!date) {
                showToast('Silakan pilih tanggal', 'warning');
                return;
            }
            
            // Get water supply cost from settings
            const waterSupplyCost = parseInt(appData.settings['Biaya Suplai Air Tangki (Rp)'] || 300000);
            
            // Calculate cost based on amount and supply cost
            const capacity = parseInt(appData.settings['Kapasitas Toren (Liter)'] || 8000);
            const costPerLiter = waterSupplyCost / capacity;
            const totalCost = Math.round(amount * costPerLiter);
            
            // Set processing state
            setProcessingState(true);
            
            // Show processing overlay
            showProcessingOverlay();
            
            // Prepare expense data
            const expenseData = {
                'Tanggal': date,
                'Keterangan': description || `Penambahan stok air ${amount} liter`,
                'Jenis': 'Stok Air',
                'Jumlah': totalCost,
                'Saldo': '-' + totalCost // Placeholder for actual balance calculation
            };
            
            // Save expense
            const expenseSuccess = await insertData('Pengeluaran', expenseData);
            
            if (expenseSuccess) {
                // Update water stock
                const waterStock = appData.waterStock;
                const settings = appData.settings;
                const currentCapacity = parseInt(settings['Kapasitas Toren (Liter)'] || 8000);
                const currentRemaining = parseInt(waterStock['Sisa Liter'] || 0);
                const currentUsed = parseInt(waterStock['Liter Terpakai'] || 0);
                const currentTotalUsed = parseInt(waterStock['Total Liter Terpakai'] || 0);
                const currentTotalCost = parseInt(waterStock['Total Biaya Suplai (Rp)'] || 300000);
                
                const newRemaining = Math.min(currentCapacity, currentRemaining + parseInt(amount));
                const newTotalUsed = currentTotalUsed; // Total used should not reset
                const newTotalCost = currentTotalCost + totalCost;
                
                // Update water stock (only update, not insert)
                const waterStockData = {
                    'Kapasitas Toren': currentCapacity,
                    'Sisa Liter': newRemaining,
                    'Liter Terpakai': 0, // Reset daily usage
                    'Total Liter Terpakai': newTotalUsed,
                    'Total Biaya Suplai (Rp)': newTotalCost
                };
                
                // Update water stock
                const waterStockSuccess = await updateData('Stok Air', 2, waterStockData);
                
                if (waterStockSuccess) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('refillModal'));
                    modal.hide();
                    
                    // Reset form
                    document.getElementById('refill-amount').value = '';
                    document.getElementById('refill-date').value = '';
                    document.getElementById('refill-description').value = '';
                    
                    // Refresh data
                    loadWaterStock();
                    loadExpenses();
                    updateWaterLevel();
                    updateWaterStockUI();
                    updateStockHistory();
                    updateWaterLevelThreshold();
                    updateFinancialSummary();
                    
                    // Add notification
                    const notificationData = {
                        'Tanggal': new Date().toISOString(),
                        'Notifikasi': `Stok air berhasil ditambahkan sebanyak ${amount} liter dengan biaya Rp ${totalCost.toLocaleString('id-ID')}`,
                        'Status': 'enable'
                    };
                    insertData('Notifikasi', notificationData);
                }
            } else {
                // Add notification for failed water refill
                const notificationData = {
                    'Tanggal': new Date().toISOString(),
                    'Notifikasi': `Gagal menambahkan stok air sebanyak ${amount} liter`,
                    'Status': 'enable'
                };
                insertData('Notifikasi', notificationData);
            }
            
            // Hide processing overlay
            hideProcessingOverlay();
            
            // Reset processing state
            setProcessingState(false);
        }
        
        async function saveSetting() {
            // Check if already processing
            if (appData.processing) {
                showToast('Proses sedang berlangsung, harap tunggu', 'warning');
                return;
            }
            
            const field = document.getElementById('edit-setting-label').textContent;
            const value = document.getElementById('edit-setting-value').value;
            
            if (!value) {
                showToast('Nilai tidak boleh kosong', 'warning');
                return;
            }
            
            // Set processing state
            setProcessingState(true);
            
            // Show processing overlay
            showProcessingOverlay();
            
            // Update setting in app data
            appData.settings[field] = value;
            
            // Update settings in spreadsheet (row 2 since settings are in the first row after header)
            const success = await updateData('Pengaturan', 2, { [field]: value });
            
            if (success) {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editSettingModal'));
                modal.hide();
                
                // Refresh settings
                loadSettings();
                
                // If water settings were updated, update water stock UI
                if (field === 'Kapasitas Toren (Liter)' || field === 'Biaya Suplai Air Tangki (Rp)') {
                    loadWaterStock();
                    updateWaterStockUI();
                    updateWaterLevelThreshold();
                }
                
                // If receipt footer was updated, update receipt footer preview
                if (field === 'Footer Nota') {
                    document.getElementById('receipt-footer-preview').textContent = value;
                }
            } else {
                // Add notification for failed setting update
                const notificationData = {
                    'Tanggal': new Date().toISOString(),
                    'Notifikasi': `Gagal memperbarui pengaturan: ${field}`,
                    'Status': 'enable'
                };
                insertData('Notifikasi', notificationData);
            }
            
            // Hide processing overlay
            hideProcessingOverlay();
            
            // Reset processing state
            setProcessingState(false);
        }
        
        function showReceipt(transactionId) {
            // Find all transactions with the same ID
            const transactionGroup = appData.transactions.filter(t => t['ID Transaksi'] === transactionId);
            
            if (transactionGroup.length === 0) {
                showToast('Transaksi tidak ditemukan', 'danger');
                return;
            }
            
            // Get customer details
            const transaction = transactionGroup[0];
            const customer = appData.customers.find(c => c['ID Pelanggan'] === transaction['ID Pelanggan']);
            
            // Get settings
            const settings = appData.settings;
            
            // Calculate total amount
            const totalAmount = transactionGroup.reduce((sum, t) => {
                return sum + (parseInt(t['Harga Jual (Rp)']) || 0) * (parseInt(t['Jumlah']) || 1);
            }, 0);
            
            // Get receipt footer from settings
            const receiptFooter = settings['Footer Nota'] || 'Terima kasih atas kunjungan Anda';
            
            // Generate receipt HTML - Alfamart Style
            const receiptContainer = document.getElementById('receipt-container');
            receiptContainer.innerHTML = `
                <div class="receipt-header">
                    <div class="receipt-logo">
                        <img src="${settings['Logo'] || 'https://forumu.github.io/gen/logo.png'}" alt="Logo">
                    </div>
                    <div class="receipt-title">${settings['Nama Usaha'] || 'YOUSHE'}</div>
                    <div class="receipt-subtitle">Depot Air Minum Isi Ulang</div>
                    <div class="receipt-subtitle">${settings['Alamat Usaha'] || 'Jaten Karanganyar'}</div>
                    <div class="receipt-subtitle">${settings['Kontak'] || '+6285867271777'}</div>
                </div>
                
                <div class="receipt-info">
                    <div class="receipt-row">
                        <div>Tanggal:</div>
                        <div>${new Date(transaction['Tanggal']).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</div>
                    </div>
                    <div class="receipt-row">
                        <div>Kasir:</div>
                        <div>Admin</div>
                    </div>
                    <div class="receipt-row">
                        <div>No. Transaksi:</div>
                        <div>${transaction['ID Transaksi']}</div>
                    </div>
                    <div class="receipt-row">
                        <div>Pelanggan:</div>
                        <div>${customer ? customer['Nama'] : 'Umum'}</div>
                    </div>
                </div>
                
                <div class="receipt-items">
                    ${transactionGroup.map(t => `
                        <div class="receipt-item">
                            <div class="receipt-item-name">${t['Produk']}</div>
                            <div class="receipt-item-qty">${t['Jumlah']}</div>
                            <div class="receipt-item-price">Rp ${parseInt(t['Harga Jual (Rp)']).toLocaleString('id-ID')}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div class="receipt-total">
                    <div class="receipt-total-row">
                        <div>Subtotal:</div>
                        <div>Rp ${totalAmount.toLocaleString('id-ID')}</div>
                    </div>
                    <div class="receipt-total-row">
                        <div>Bayar:</div>
                        <div>Rp ${totalAmount.toLocaleString('id-ID')}</div>
                    </div>
                    <div class="receipt-total-row receipt-grand-total">
                        <div>Kembali:</div>
                        <div>Rp 0</div>
                    </div>
                </div>
                
                <div class="receipt-footer">
                    <div>${receiptFooter}</div>
                    <div>Barang yang sudah dibeli tidak dapat dikembalikan</div>
                </div>
            `;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
            modal.show();
        }
        
        function printReceipt() {
            window.print();
        }
        
        // Download Receipt as Image
        function downloadReceiptAsImage() {
            const receiptElement = document.getElementById('receipt-container');
            
            html2canvas(receiptElement, {
                scale: 2, // Higher resolution
                logging: false,
                useCORS: true
            }).then(canvas => {
                // Convert canvas to data URL
                const dataURL = canvas.toDataURL('image/png');
                
                // Create download link
                const link = document.createElement('a');
                link.download = `nota-${new Date().getTime()}.png`;
                link.href = dataURL;
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('Nota berhasil diunduh sebagai gambar', 'success');
            }).catch(error => {
                console.error('Error generating receipt image:', error);
                showToast('Gagal mengunduh nota sebagai gambar', 'danger');
            });
        }
        
        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            if (!searchTerm) {
                // If search is empty, show all items
                if (appData.productView === 'list') {
                    updateProductsListView();
                } else {
                    updateProductsGridView();
                }
                updateCustomersUI();
                updateTransactionHistoryUI();
                updateDebtUI();
                return;
            }
            
            // Filter products
            const filteredProducts = appData.products.filter(p => 
                (p['Nama Produk'] && p['Nama Produk'].toLowerCase().includes(searchTerm))
            );
            
            // Filter customers
            const filteredCustomers = appData.customers.filter(c => 
                (c['Nama'] && c['Nama'].toLowerCase().includes(searchTerm)) ||
                (c['Kontak'] && c['Kontak'].includes(searchTerm))
            );
            
            // Filter transactions
            const filteredTransactions = appData.transactions.filter(t => 
                (t['ID Transaksi'] && t['ID Transaksi'].toLowerCase().includes(searchTerm)) ||
                (t['Nama Pelanggan'] && t['Nama Pelanggan'].toLowerCase().includes(searchTerm)) ||
                (t['Produk'] && t['Produk'].toLowerCase().includes(searchTerm))
            );
            
            // Update UI with filtered results
            if (appData.productView === 'list') {
                updateFilteredProductsListView(filteredProducts);
            } else {
                updateFilteredProductsGridView(filteredProducts);
            }
            updateFilteredCustomersUI(filteredCustomers);
            updateFilteredTransactionsUI(filteredTransactions);
        }
        
        function updateFilteredProductsListView(products) {
            const container = document.getElementById('product-list-container');
            container.innerHTML = '';
            
            if (products.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada produk yang cocok</div>';
                return;
            }
            
            products.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'product-list-item';
                productItem.setAttribute('data-id', product['ID Produk']);
                
                // Check if product is selected
                const isSelected = appData.selectedProducts[product['ID Produk']] || 0;
                
                // Add selected class if product is in cart
                if (isSelected > 0) {
                    productItem.classList.add('selected');
                }
                
                productItem.innerHTML = `
                    <div class="product-list-icon">
                        <i class="bi bi-droplet"></i>
                    </div>
                    <div class="product-list-info">
                        <div class="product-list-name">${product['Nama Produk'] || 'Unknown Product'}</div>
                        <div class="product-list-details">
                            <div class="product-list-stock">Stok: ${product['Liter'] || 0} L</div>
                            <div class="product-list-price">Rp ${parseInt(product['Harga Jual (Rp)'] || 0).toLocaleString('id-ID')}</div>
                        </div>
                    </div>
                    ${isSelected > 0 ? `<div class="product-list-quantity">${isSelected}</div>` : ''}
                `;
                
                productItem.addEventListener('click', function() {
                    selectProduct(product);
                });
                
                container.appendChild(productItem);
            });
        }
        
        function updateFilteredProductsGridView(products) {
            const container = document.getElementById('product-grid-container');
            container.innerHTML = '';
            
            if (products.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada produk yang cocok</div>';
                return;
            }
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.setAttribute('data-id', product['ID Produk']);
                
                // Check if product is selected
                const isSelected = appData.selectedProducts[product['ID Produk']] || 0;
                
                productCard.innerHTML = `
                    <div class="product-image">
                        <i class="bi bi-droplet"></i>
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product['Nama Produk'] || 'Unknown Product'}</div>
                        <div class="product-price">Rp ${parseInt(product['Harga Jual (Rp)'] || 0).toLocaleString('id-ID')}</div>
                        <div class="product-stock">Stok: ${product['Liter'] || 0} L</div>
                    </div>
                    ${isSelected > 0 ? `<div class="product-quantity-badge">${isSelected}</div>` : ''}
                `;
                
                productCard.addEventListener('click', function() {
                    selectProduct(product);
                });
                
                container.appendChild(productCard);
            });
        }
        
        function updateFilteredCustomersUI(customers) {
            const container = document.getElementById('customers-container');
            container.innerHTML = '';
            
            if (customers.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada pelanggan yang cocok</div>';
                return;
            }
            
            customers.forEach(customer => {
                const customerItem = document.createElement('div');
                customerItem.className = 'customer-item';
                
                // Get initials for avatar
                const name = customer['Nama'] || 'Unknown';
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
                
                // Format WhatsApp number
                let whatsappNumber = customer['Kontak'] || '';
                if (whatsappNumber) {
                    // Remove spaces and dashes
                    whatsappNumber = whatsappNumber.replace(/[\s-]/g, '');
                    // Replace leading 0 with +62
                    if (whatsappNumber.startsWith('0')) {
                        whatsappNumber = '+62' + whatsappNumber.substring(1);
                    }
                }
                
                customerItem.innerHTML = `
                    <div class="customer-avatar">${initials}</div>
                    <div class="customer-info">
                        <div class="customer-name" style="cursor: pointer;" data-id="${customer['ID Pelanggan']}" data-name="${name}" data-contact="${customer['Kontak'] || ''}" data-address="${customer['Alamat'] || ''}" data-deposit="${customer['Galon Titipan'] || 0}" data-maps="${customer['Maps'] || ''}">${name}</div>
                        <div class="customer-stats">${customer['Kontak'] || 'No contact'}</div>
                        <div class="customer-stats">${customer['Alamat'] || 'No address'}</div>
                        ${customer['Galon Titipan'] > 0 ? `<div class="customer-stats">Galon Titipan: ${customer['Galon Titipan']}</div>` : ''}
                        ${customer['Maps'] ? `<div class="customer-stats"><i class="bi bi-geo-alt"></i> Lokasi tersedia</div>` : ''}
                    </div>
                    <div class="customer-actions">
                        ${whatsappNumber ? `<a href="https://wa.me/${whatsappNumber.replace(/\+/g, '')}" target="_blank" class="customer-action whatsapp" title="WhatsApp">
                            <i class="bi bi-whatsapp"></i>
                        </a>` : ''}
                        ${customer['Maps'] ? `<a href="#" class="customer-action location" title="Lokasi" data-maps="${customer['Maps']}">
                            <i class="bi bi-geo-alt"></i>
                        </a>` : ''}
                    </div>
                `;
                container.appendChild(customerItem);
            });
            
            // Add event listeners to customer names
            document.querySelectorAll('.customer-name').forEach(nameElement => {
                nameElement.addEventListener('click', function() {
                    const customerId = this.getAttribute('data-id');
                    const customerName = this.getAttribute('data-name');
                    showEditCustomerModal(customerId, customerName);
                });
            });
            
            // Add event listeners to location buttons
            document.querySelectorAll('.customer-action.location').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const mapsUrl = this.getAttribute('data-maps');
                    showMapsModal(mapsUrl);
                });
            });
        }
        
        function updateFilteredTransactionsUI(transactions) {
            const container = document.getElementById('transaction-history-list');
            container.innerHTML = '';
            
            if (transactions.length === 0) {
                container.innerHTML = '<div class="text-center p-4">Tidak ada transaksi yang cocok</div>';
                return;
            }
            
            // Group transactions by ID Transaksi
            const groupedTransactions = {};
            transactions.forEach(transaction => {
                const id = transaction['ID Transaksi'];
                if (!groupedTransactions[id]) {
                    groupedTransactions[id] = [];
                }
                groupedTransactions[id].push(transaction);
            });
            
            // Sort transactions by date (newest first)
            const sortedTransactions = Object.values(groupedTransactions)
                .sort((a, b) => new Date(b[0]['Tanggal']) - new Date(a[0]['Tanggal']));
            
            sortedTransactions.forEach(transactionGroup => {
                const transaction = transactionGroup[0];
                const transactionItem = document.createElement('li');
                transactionItem.className = 'card-item';
                
                const date = new Date(transaction['Tanggal']);
                const formattedDate = date.toLocaleDateString('id-ID', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric' 
                });
                
                const statusClass = transaction['Status'] === 'Lunas' ? 'status-lunas' : 
                                  transaction['Status'] === 'Hutang' ? 'status-hutang' : 
                                  transaction['Status'] === 'Manual' ? 'status-manual' : 'status-cicil';
                
                // Calculate total amount for this transaction group
                const totalAmount = transactionGroup.reduce((sum, t) => {
                    return sum + (parseInt(t['Harga Jual (Rp)']) || 0) * (parseInt(t['Jumlah']) || 1);
                }, 0);
                
                transactionItem.innerHTML = `
                    <div class="card-icon">
                        <i class="bi bi-receipt"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-title">${transaction['ID Transaksi'] || 'Unknown'}</div>
                        <div class="card-subtitle">${formattedDate}  ${transaction['Nama Pelanggan'] || 'Unknown'}</div>
                        <span class="transaction-status ${statusClass}">${transaction['Status'] || 'Unknown'}</span>
                    </div>
                    <div class="card-value">Rp ${totalAmount.toLocaleString('id-ID')}</div>
                    <div class="transaction-actions">
                        <div class="transaction-action" onclick="showReceipt('${transaction['ID Transaksi']}')">
                            <i class="bi bi-printer"></i>
                        </div>
                    </div>
                `;
                container.appendChild(transactionItem);
            });
        }
        
        // Fungsi untuk refresh data berdasarkan tab yang aktif
        function refreshTabData(tabId) {
            switch(tabId) {
                case 'dashboard-tab':
                    loadSettings();
                    loadProducts();
                    loadCustomers();
                    loadTransactions();
                    loadWaterStock();
                    loadExpenses();
                    loadNotifications();
                    updateDashboardStats();
                    updateFinancialSummary();
                    updateSalesChart();
                    updateWaterLevel();
                    updateTransactionDate();
                    updateTopProducts();
                    updateActiveCustomers();
                    updateMonthlyExpense();
                    break;
                    
                case 'transaksi-tab':
                    loadProducts();
                    loadCustomers();
                    break;
                    
                case 'riwayat-tab':
                    loadTransactions();
                    updateTransactionHistoryUI();
                    updateDebtUI();
                    break;
                    
                case 'produk-tab':
                    loadProducts();
                    break;
                    
                case 'pelanggan-tab':
                    loadCustomers();
                    break;
                    
                case 'stok-tab':
                    loadWaterStock();
                    updateWaterStockUI();
                    updateStockHistory();
                    updateWaterLevelThreshold();
                    break;
                    
                case 'pengeluaran-tab':
                    loadExpenses();
                    updateExpensesUI();
                    updateMonthlyExpense();
                    break;
                    
                case 'pengaturan-tab':
                    loadSettings();
                    break;
            }
        }
        
        // Payment Functions
        function showPaymentModal(transactionId, customerName, totalDebt) {
            // Set modal values
            document.getElementById('payment-transaction-id').value = transactionId;
            document.getElementById('payment-customer-name').value = customerName;
            document.getElementById('payment-total-debt').value = `Rp ${totalDebt.toLocaleString('id-ID')}`;
            document.getElementById('payment-amount').value = totalDebt;
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }
        
        // PERBAIKAN: Fungsi savePayment() yang diperbaiki untuk memastikan popup tertutup otomatis
        async function savePayment() {
            // Check if already processing
            if (appData.processing) {
                showToast('Proses sedang berlangsung, harap tunggu', 'warning');
                return;
            }
            
            // Get form values
            const transactionId = document.getElementById('payment-transaction-id').value;
            const paymentAmount = parseInt(document.getElementById('payment-amount').value) || 0;
            const paymentDate = document.getElementById('payment-date').value;
            
            // Validate inputs
            if (!transactionId) {
                showToast('ID transaksi tidak ditemukan', 'danger');
                return;
            }
            
            if (!paymentAmount || paymentAmount <= 0) {
                showToast('Silakan masukkan jumlah pembayaran yang valid', 'warning');
                return;
            }
            
            if (!paymentDate) {
                showToast('Silakan pilih tanggal pembayaran', 'warning');
                return;
            }
            
            // Find all transactions with the same ID
            const transactionGroup = appData.transactions.filter(t => t['ID Transaksi'] === transactionId);
            
            if (transactionGroup.length === 0) {
                showToast('Transaksi tidak ditemukan', 'danger');
                return;
            }
            
            // Get the main transaction
            const mainTransaction = transactionGroup[0];
            const remainingDebt = parseInt(mainTransaction['Sisa Hutang']) || 0;
            
            // PERBAIKAN: Pastikan paymentAmount tidak melebihi sisa hutang
            const validPaymentAmount = Math.min(paymentAmount, remainingDebt);
            
            // Set processing state
            setProcessingState(true);
            
            // Show processing overlay
            showProcessingOverlay();
            
            // Calculate new remaining debt
            const newRemainingDebt = remainingDebt - validPaymentAmount;
            
            // Determine new status
            const newStatus = newRemainingDebt === 0 ? 'Lunas' : 'Hutang';
            
            // Update all transactions with the same ID
            let allTransactionsUpdated = true;
            
            for (const transaction of transactionGroup) {
                // Update transaction data
                const transactionData = {
                    'Status': newStatus,
                    'Sisa Hutang': newRemainingDebt
                };
                
                // Find the transaction index
                const transactionIndex = appData.transactions.findIndex(t => 
                    t['ID Transaksi'] === transaction['ID Transaksi'] && 
                    t['Produk'] === transaction['Produk']
                );
                
                if (transactionIndex !== -1) {
                    // Update the transaction in app data
                    appData.transactions[transactionIndex]['Status'] = newStatus;
                    appData.transactions[transactionIndex]['Sisa Hutang'] = newRemainingDebt;
                    
                    // Update the transaction in spreadsheet (row number = index + 2 for header and 1-based index)
                    const success = await updateData('Transaksi', transactionIndex + 2, transactionData);
                    
                    if (!success) {
                        allTransactionsUpdated = false;
                    }
                } else {
                    allTransactionsUpdated = false;
                }
            }
            
            if (allTransactionsUpdated) {
                // Add payment record
                const paymentData = {
                    'Tanggal': paymentDate,
                    'ID Transaksi': transactionId,
                    'ID Pelanggan': mainTransaction['ID Pelanggan'],
                    'Nama Pelanggan': mainTransaction['Nama Pelanggan'],
                    'Jumlah': validPaymentAmount,
                    'Keterangan': `Pembayaran hutang untuk transaksi ${transactionId}`,
                    'Jenis': 'Pembayaran Hutang'
                };
                
                // Save payment record
                const paymentSuccess = await insertData('Pembayaran', paymentData);
                
                if (paymentSuccess) {
                    // Refresh data
                    loadTransactions();
                    updateDashboardStats();
                    updateFinancialSummary();
                    updateTransactionHistoryUI();
                    updateDebtUI();
                    
                    // Show success notification
                    showToast('Pembayaran berhasil disimpan', 'success');
                    
                    // Add notification
                    const notificationData = {
                        'Tanggal': new Date().toISOString(),
                        'Notifikasi': `Pembayaran hutang berhasil! Transaksi: ${transactionId}, Jumlah: Rp ${validPaymentAmount.toLocaleString('id-ID')}`,
                        'Status': 'enable'
                    };
                    insertData('Notifikasi', notificationData);
                    
                    // PERBAIKAN: Tutup modal secara otomatis setelah pembayaran berhasil
                    try {
                        const modalElement = document.getElementById('paymentModal');
                        if (modalElement) {
                            // Dapatkan instance modal yang sudah ada
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) {
                                modalInstance.hide();
                            } else {
                                // Jika tidak ada instance, buat instance baru dan sembunyikan
                                const newModal = new bootstrap.Modal(modalElement);
                                newModal.hide();
                            }
                            
                            // Tunggu hingga animasi penutupan selesai
                            setTimeout(() => {
                                // Hapus backdrop jika masih ada
                                const backdrops = document.querySelectorAll('.modal-backdrop');
                                backdrops.forEach(backdrop => {
                                    backdrop.remove();
                                });
                                
                                // Hapus class 'modal-open' dari body jika masih ada
                                document.body.classList.remove('modal-open');
                            }, 300);
                        }
                    } catch (error) {
                        console.error('Error closing payment modal:', error);
                    }
                } else {
                    showToast('Terjadi kesalahan saat menyimpan pembayaran', 'danger');
                }
            } else {
                showToast('Terjadi kesalahan saat memperbarui transaksi', 'danger');
            }
            
            // Hide processing overlay
            hideProcessingOverlay();
            
            // Reset processing state
            setProcessingState(false);
        }
        
        // PERBAIKAN: Fungsi untuk memvalidasi konsistensi data hutang
        function validateDebtConsistency(transactionId) {
            const transactionGroup = appData.transactions.filter(t => t['ID Transaksi'] === transactionId);
            
            if (transactionGroup.length === 0) return false;
            
            // Hitung total nilai transaksi
            const totalValue = transactionGroup.reduce((sum, t) => {
                return sum + (parseInt(t['Harga Jual (Rp)']) || 0) * (parseInt(t['Jumlah']) || 1);
            }, 0);
            
            // Ambil sisa hutang dari transaksi pertama (seharusnya sama untuk semua)
            const remainingDebt = parseInt(transactionGroup[0]['Sisa Hutang']) || 0;
            
            // Hitung total pembayaran manual
            const manualPayment = parseInt(transactionGroup[0]['Jumlah Bayar Manual']) || 0;
            
            // Validasi: totalValue - manualPayment harus sama dengan remainingDebt
            const expectedDebt = totalValue - manualPayment;
            
            if (expectedDebt !== remainingDebt) {
                console.error(`Inconsistency detected for transaction ${transactionId}:`, {
                    totalValue,
                    manualPayment,
                    expectedDebt,
                    actualDebt: remainingDebt
                });
                return false;
            }
            
            return true;
        }
        
        // PERBAIKAN: Fungsi untuk memperbaiki data yang tidak konsisten
        async function fixDebtInconsistencies() {
            // Group transactions by ID Transaksi
            const groupedTransactions = {};
            appData.transactions.forEach(transaction => {
                const id = transaction['ID Transaksi'];
                if (!groupedTransactions[id]) {
                    groupedTransactions[id] = [];
                }
                groupedTransactions[id].push(transaction);
            });
            
            // Periksa setiap grup transaksi
            for (const [transactionId, transactions] of Object.entries(groupedTransactions)) {
                // Hitung total nilai transaksi
                const totalValue = transactions.reduce((sum, t) => {
                    return sum + (parseInt(t['Harga Jual (Rp)']) || 0) * (parseInt(t['Jumlah']) || 1);
                }, 0);
                
                // Ambil sisa hutang dari transaksi pertama
                const remainingDebt = parseInt(transactions[0]['Sisa Hutang']) || 0;
                
                // Hitung total pembayaran manual
                const manualPayment = parseInt(transactions[0]['Jumlah Bayar Manual']) || 0;
                
                // Hitung sisa hutang yang diharapkan
                const expectedDebt = totalValue - manualPayment;
                
                // Jika ada ketidaksesuaian, perbaiki
                if (expectedDebt !== remainingDebt) {
                    console.log(`Fixing debt inconsistency for transaction ${transactionId}:`, {
                        totalValue,
                        manualPayment,
                        oldDebt: remainingDebt,
                        newDebt: expectedDebt
                    });
                    
                    // Update semua transaksi dalam grup
                    for (const transaction of transactions) {
                        const transactionIndex = appData.transactions.findIndex(t => 
                            t['ID Transaksi'] === transaction['ID Transaksi'] && 
                            t['Produk'] === transaction['Produk']
                        );
                        
                        if (transactionIndex !== -1) {
                            // Update di app data
                            appData.transactions[transactionIndex]['Sisa Hutang'] = expectedDebt;
                            
                            // Update di spreadsheet
                            await updateData('Transaksi', transactionIndex + 2, {
                                'Sisa Hutang': expectedDebt
                            });
                        }
                    }
                }
            }
            
            // Refresh UI tanpa menampilkan notifikasi
            updateDebtUI();
            updateDashboardStats();
            updateFinancialSummary();
        }
        
        // Fungsi untuk menampilkan animasi loading pada FAB button
        function showRefreshAnimation() {
            const fabButton = document.getElementById('fab-button');
            const originalContent = fabButton.innerHTML;
            
            // Tampilkan animasi refresh
            fabButton.innerHTML = '<i class="bi bi-arrow-clockwise rotating"></i>';
            fabButton.style.pointerEvents = 'none';
            
            // Kembalikan ke kondisi semula setelah 2 detik
            setTimeout(() => {
                fabButton.innerHTML = originalContent;
                fabButton.style.pointerEvents = 'auto';
            }, 2000);
        }
        
        // Fungsi untuk menampilkan overlay pemrosesan
        function showProcessingOverlay() {
            const overlay = document.getElementById('processing-overlay');
            overlay.classList.add('active');
        }
        
        // Fungsi untuk menyembunyikan overlay pemrosesan
        function hideProcessingOverlay() {
            const overlay = document.getElementById('processing-overlay');
            overlay.classList.remove('active');
        }
        
        // Reset All Data Function
        async function resetAllData() {
            if (!confirm('Apakah Anda yakin ingin mereset semua data? Tindakan ini tidak dapat dibatalkan dan akan menghapus semua data dari semua sheet.')) {
                return;
            }
            
            // Show processing overlay
            showProcessingOverlay();
            
            try {
                // Get all sheet names
                const sheets = ['Produk', 'Pelanggan', 'Transaksi', 'Pengeluaran', 'Stok Air', 'Notifikasi', 'Pengaturan'];
                
                // Reset each sheet
                for (const sheet of sheets) {
                    // Get all data from the sheet
                    const data = await fetchData(sheet);
                    
                    if (data && data.length > 0) {
                        // Delete all rows except the header
                        for (let i = data.length; i >= 1; i--) {
                            await updateData(sheet, i + 1, { 'delete': 'true' });
                        }
                    }
                }
                
                // Clear local data
                appData = {
                    transactions: [],
                    products: [],
                    waterStock: {},
                    customers: [],
                    expenses: [],
                    settings: {},
                    notifications: [],
                    cart: [],
                    selectedPaymentMethod: 'Lunas',
                    dailySales: {},
                    selectedCustomer: null,
                    selectedProducts: {},
                    processing: false,
                    menuSettings: {
                        'dashboard-tab': { visible: true, position: 'bottom' },
                        'transaksi-tab': { visible: true, position: 'bottom' },
                        'riwayat-tab': { visible: true, position: 'bottom' },
                        'produk-tab': { visible: true, position: 'bottom' },
                        'pelanggan-tab': { visible: true, position: 'bottom' },
                        'stok-tab': { visible: true, position: 'bottom' },
                        'pengeluaran-tab': { visible: true, position: 'bottom' },
                        'pengaturan-tab': { visible: true, position: 'bottom' }
                    },
                    productView: 'list',
                    activeTab: 'transaction-history-tab'
                };
                
                // Refresh UI
                updateDashboardStats();
                updateFinancialSummary();
                updateSalesChart();
                updateWaterLevel();
                updateTransactionDate();
                updateTopProducts();
                updateActiveCustomers();
                updateMonthlyExpense();
                updateProductsUI();
                updateCustomersUI();
                updateTransactionsUI();
                updateWaterStockUI();
                updateExpensesUI();
                updateNotificationsUI();
                updateNotificationBadge();
                updateNotificationDropdown();
                updateSettingsUI();
                updateSettingsBanner();
                
                showToast('Semua data berhasil direset', 'success');
            } catch (error) {
                console.error('Error resetting data:', error);
                showToast('Gagal mereset data: ' + error.message, 'danger');
            } finally {
                // Hide processing overlay
                hideProcessingOverlay();
            }
        }
        
        // Backup Settings Function
        function backupSettings() {
            // Create backup object with all settings
            const backup = {
                settings: appData.settings,
                menuSettings: appData.menuSettings,
                timestamp: new Date().toISOString()
            };
            
            // Convert to JSON
            const backupJson = JSON.stringify(backup, null, 2);
            
            // Create blob
            const blob = new Blob([backupJson], { type: 'application/json' });
            
            // Create download link
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-settings-${new Date().toISOString().slice(0, 10)}.json`;
            
            // Trigger download
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
            
            showToast('Pengaturan berhasil dibackup', 'success');
        }
        
        // Import Backup Function
        function importBackup(file) {
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    // Parse JSON
                    const backup = JSON.parse(e.target.result);
                    
                    // Validate backup structure
                    if (!backup.settings || !backup.menuSettings) {
                        showToast('File backup tidak valid', 'danger');
                        return;
                    }
                    
                    // Show processing overlay
                    showProcessingOverlay();
                    
                    // Update settings
                    appData.settings = backup.settings;
                    appData.menuSettings = backup.menuSettings;
                    
                    // Update UI
                    updateSettingsUI();
                    updateMenuVisibility();
                    updateMenuPosition();
                    updateSettingsBanner();
                    
                    // Save settings to spreadsheet
                    const settingsData = {};
                    Object.keys(backup.settings).forEach(key => {
                        settingsData[key] = backup.settings[key];
                    });
                    
                    // Save menu settings to spreadsheet
                    const menuAtas = Object.keys(backup.menuSettings)
                        .filter(key => backup.menuSettings[key].position === 'header' && backup.menuSettings[key].visible)
                        .map(key => key.replace('-tab', ''))
                        .join(',');
                    
                    const menuBawah = Object.keys(backup.menuSettings)
                        .filter(key => backup.menuSettings[key].position === 'bottom' && backup.menuSettings[key].visible)
                        .map(key => key.replace('-tab', ''))
                        .join(',');
                    
                    settingsData['Menu Atas'] = menuAtas;
                    settingsData['Menu Bawah'] = menuBawah;
                    
                    // Update settings in spreadsheet
                    await updateData('Pengaturan', 2, settingsData);
                    
                    showToast('Pengaturan berhasil diimpor', 'success');
                } catch (error) {
                    console.error('Error importing backup:', error);
                    showToast('Gagal mengimpor pengaturan: ' + error.message, 'danger');
                } finally {
                    // Hide processing overlay
                    hideProcessingOverlay();
                }
            };
            
            reader.readAsText(file);
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            const headerClass = type === 'success' ? 'bg-success' : 
                               type === 'danger' ? 'bg-danger' : 
                               type === 'warning' ? 'bg-warning' : 'bg-primary';
            
            toast.innerHTML = `
                <div class="toast-header ${headerClass}">
                    <strong class="me-auto">Notifikasi</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 3000
            });
            
            bsToast.show();
            
            // Remove toast element after it's hidden
            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }
    </script>
</body>
</html>
